# Документация по системе генерации и визуализации задач

В систему генерации задач добавлена поддержка визуализации геометрических фигур, графиков и диаграмм, а также механизмы умной аналитики и оптимизации расходов.

## Основные изменения и нововведения

### 1. Поддержка визуализации (Visual Tasks)
Теперь вопросы могут сопровождаться визуальным контентом.
- **Новые поля**:
  - `is_visual` (bool): Флаг наличия визуализации.
  - `visualization` (object): Данные для отрисовки (координаты, типы фигур, параметры).
- **Типы визуализации**:
  - `geometric_shape`: Геометрические фигуры (одна или несколько).
  - `graph`: Графики функций (одна или несколько линий).
  - `diagram` / `chart`: Диаграммы и гистограммы.

### 2. Умная аналитика с LLM
В конце сессии пользователь получает не просто процент правильных ответов, а детальный текстовый разбор.
- **Персональный фидбек**: LLM анализирует историю ответов и дает комментарий по *каждому* вопросу, объясняя ошибки или отмечая успехи.
- **Общее резюме**: Тьюторский комментарий по всей сессии с рекомендациями.
- **Поля в ответе**:
  - `questions_review`: Массив с разбором каждого вопроса.
  - `tutor_comment`: Итоговое резюме.
  - `gaps`: Конкретные пробелы в знаниях.
  - `recommended_focus`: Четкое действие для улучшения результата.

### 3. Защита от повторов
- В рамках одной сессии система отслеживает заданные промпты.
- При генерации нового вопроса в LLM передаются последние 3 вопроса (контекст), чтобы исключить создание дубликатов.
- Сгенерированные вопросы сохраняются в графовую базу данных (Neo4j) для повторного использования.

---

## Оценка стоимости (Token Usage)

Ниже приведен расчет потребления токенов при использовании модели уровня GPT-4o-mini / GPT-3.5 Turbo.

### 1. Генерация одного вопроса
Если подходящего вопроса нет в базе, система генерирует его с нуля.
*   **Вход (Prompt):** ~600-700 токенов (контекст, инструкции JSON, примеры визуализации, история).
*   **Выход (Completion):** ~200-300 токенов (JSON вопроса).
*   **Итого:** ~900 - 1000 токенов за вопрос.

### 2. Финальная аналитика
Запускается один раз в конце сессии.
*   **Вход:** ~2000-2500 токенов (история всей сессии: вопросы + ответы пользователя + правильные ответы).
*   **Выход:** ~800-1200 токенов (детальный разбор).
*   **Итого:** ~3000 - 4000 токенов за сессию.

### Общий расход на тест из 10 вопросов

| Сценарий использования | Расход токенов (approx.) | Стоимость (GPT-4o-mini)* |
| :--- | :--- | :--- |
| **Полная генерация** (База пустая, всё генерирует LLM) | **~13 000 - 14 000 токенов** | **~ $0.01 - $0.02** |

*\* Расчет для GPT-4o-mini ($0.15 вход / $0.60 выход за 1М токенов).*

---

## Структура данных визуализации

Объект `visualization` имеет следующую структуру:

```json
{
  "type": "geometric_shape" | "graph" | "diagram" | "chart",
  "coordinates": [ ... ] | { ... },
  "params": { ... }
}
```

### Примеры форматов

#### 1. geometric_shape
Может содержать одну фигуру (список точек) или несколько фигур (список объектов).

**Вариант А: Одна фигура (список точек)**
```json
{
  "type": "geometric_shape",
  "coordinates": [
    {"x": 0, "y": 0},
    {"x": 10, "y": 0},
    {"x": 5, "y": 8.66}
  ],
  "params": {
    "color": "#FF0000",
    "labels": ["A", "B", "C"]
  }
}
```

**Вариант Б: Несколько фигур (список объектов)**
```json
{
  "type": "geometric_shape",
  "coordinates": [
    {
      "points": [{"x": 0, "y": 0}, {"x": 4, "y": 0}, {"x": 0, "y": 3}],
      "color": "blue",
      "label": "Triangle 1"
    },
    {
      "points": [{"x": 5, "y": 0}, {"x": 9, "y": 0}, {"x": 5, "y": 3}],
      "color": "red",
      "label": "Triangle 2"
    }
  ],
  "params": {
    "grid": true
  }
}
```

#### 2. graph
Может содержать одну функцию или массив функций.

**Вариант А: Одна функция**
```json
{
  "type": "graph",
  "coordinates": {
    "function": "x^2",
    "range_x": [-10, 10],
    "range_y": [0, 100]
  },
  "params": {
    "grid": true
  }
}
```

**Вариант Б: Несколько линий**
```json
{
  "type": "graph",
  "coordinates": [
    {"function": "x^2", "color": "blue"},
    {"function": "x + 2", "color": "red"}
  ],
  "params": {
    "range_x": [-10, 10],
    "range_y": [0, 20],
    "grid": true
  }
}
```

---

## Примеры ответов API

### 1. Ответ `/start` (JSON)

Возвращает первый вопрос сессии.

```json
{
  "items": [
    {
      "question_uid": "Q-GEN-a1b2c3d4",
      "subject_uid": "subject_math_01",
      "topic_uid": "topic_geometry_01",
      "type": "single_choice",
      "prompt": "Найдите площадь треугольника с вершинами в точках (0,0), (4,0) и (0,3).",
      "options": [
        {"option_uid": "opt_1", "text": "6", "is_correct": true},
        {"option_uid": "opt_2", "text": "12", "is_correct": false},
        {"option_uid": "opt_3", "text": "7", "is_correct": false},
        {"option_uid": "opt_4", "text": "5", "is_correct": false}
      ],
      "meta": {
        "difficulty": 0.5,
        "skill_uid": null,
        "generated": true
      },
      "is_visual": true,
      "visualization": {
        "type": "geometric_shape",
        "coordinates": [
          {"x": 0, "y": 0},
          {"x": 4, "y": 0},
          {"x": 0, "y": 3}
        ],
        "params": {
          "color": "blue",
          "labels": ["A", "B", "C"]
        }
      }
    }
  ],
  "meta": {
    "assessment_session_id": "sess_12345678"
  }
}
```

### 2. Ответ `/next` (Server-Sent Events)

Потоковый ответ. Может содержать событие `question` (следующий вопрос) или `done` (конец сессии с аналитикой).

#### Событие: Следующий вопрос

```text
event: question
data: {
  "items": [
    {
      "question_uid": "Q-GEN-e5f6g7h8",
      "subject_uid": "subject_math_01",
      "topic_uid": "topic_functions_02",
      "type": "numeric",
      "prompt": "Определите значение функции y = x^2 в точке x = 2.",
      "options": [],
      "meta": {
        "difficulty": 0.6,
        "skill_uid": null,
        "generated": true
      },
      "is_visual": true,
      "visualization": {
        "type": "graph",
        "coordinates": [
           {"function": "x^2", "color": "blue"},
           {"function": "4", "color": "red", "line_style": "dashed"}
        ],
        "params": {
          "grid": true,
          "highlight_point": {"x": 2, "y": 4}
        }
      }
    }
  ],
  "meta": {}
}
```

#### Событие: Завершение сессии (Аналитика)

Возвращает детальный разбор и рекомендации.

```text
event: done
data: {
  "items": [
    {
      "topic_uid": "topic_geometry_01",
      "level": "intermediate",
      "mastery": {
        "score": 0.85
      },
      "analytics": {
        "gaps": [
          "Путает формулы площади и периметра",
          "Ошибки при работе с отрицательными координатами"
        ],
        "recommended_focus": "Повторить раздел 'Координатная плоскость' и решить 5 задач на построение фигур.",
        "strength": "Хорошая скорость ответов",
        "current_percentage": 85,
        "topic_breakdown": [
          { "subtopic": "Theory", "mastery": 93 },
          { "subtopic": "Practice", "mastery": 85 },
          { "subtopic": "Application", "mastery": 76 }
        ],
        "questions_review": [
          {
            "question_uid": "Q-GEN-a1b2c3d4",
            "feedback": "Верно. Отлично применена теорема Пифагора."
          },
          {
            "question_uid": "Q-GEN-e5f6g7h8",
            "feedback": "Ошибка. Вы использовали диаметр вместо радиуса в формуле площади."
          }
        ],
        "tutor_comment": "В целом отличный результат! Вы уверенно владеете базовыми понятиями, но стоит быть внимательнее при подстановке значений в формулы."
      }
    }
  ],
  "meta": {}
}
```
