# Документация по визуализации задач

В систему генерации задач добавлена поддержка визуализации геометрических фигур, графиков и диаграмм.

## Основные изменения

### 1. Новые поля в QuestionDTO

В ответ API `/v1/assessment/start` и `/v1/assessment/next` (в потоке событий) добавлены поля:

- `is_visual` (bool): Флаг, указывающий на наличие визуализации.
- `visualization` (object): Объект с данными для отрисовки (присутствует только если `is_visual=true`).

### 2. Структура данных визуализации

Объект `visualization` имеет следующую структуру:

```json
{
  "type": "geometric_shape" | "graph" | "diagram" | "chart",
  "coordinates": [ ... ],
  "params": { ... }
}
```

#### Типы (VisualizationType)

- `geometric_shape`: Геометрические фигуры (треугольники, круги и т.д.)
- `graph`: Графики функций
- `diagram`: Диаграммы
- `chart`: Гистограммы, графики данных

### 3. Форматы координат

#### geometric_shape

Массив точек с координатами `x` и `y`.

Пример (Треугольник):
```json
{
  "type": "geometric_shape",
  "coordinates": [
    {"x": 0, "y": 0},
    {"x": 10, "y": 0},
    {"x": 5, "y": 8.66}
  ],
  "params": {
    "color": "#FF0000",
    "stroke_width": 2,
    "labels": ["A", "B", "C"]
  }
}
```

#### graph

Может содержать параметры функции или набор точек.

Пример (Парабола):
```json
{
  "type": "graph",
  "coordinates": {
    "function": "x^2",
    "range_x": [-10, 10],
    "range_y": [0, 100]
  },
  "params": {
    "color": "blue",
    "grid": true
  }
}
```

### 4. Логика генерации

Система автоматически определяет необходимость визуализации на основе названия темы (topic_uid/title).
Ключевые слова, активирующие визуализацию: "geometry", "triangle", "circle", "graph", "function", "chart", "diagram", "геометрия", "треугольник", "график", "функция", "окружность".

Если тема определена как визуальная, в LLM отправляется дополнительный промпт с требованием сгенерировать JSON-структуру визуализации.

## Логика генерации и выборки вопросов

Процесс получения вопроса для пользователя состоит из двух этапов: попытки найти существующий вопрос и, в случае неудачи, генерации нового с помощью LLM.

### 1. Выборка существующих вопросов

Система сначала обращается к базе знаний (Neo4j) и файловым хранилищам (JSONL) для поиска готовых вопросов.

**Алгоритм выборки:**
1.  **Запрос к Neo4j**:
    *   Выполняется поиск узлов `Question` или `Example`, связанных с указанной темой (`topic_uid`).
    *   Фильтрация по сложности (`difficulty`): выбираются вопросы, попадающие в заданный диапазон сложности.
    *   Исключение уже заданных вопросов (`exclude_uids`).
2.  **Файловый резерв (JSONL)**:
    *   Если Neo4j недоступен или вернул пустой результат, система ищет вопросы в файле `backend/app/kb/examples.jsonl`.
    *   Применяется аналогичная фильтрация по теме и сложности.
3.  **Заглушки (Fallback)**:
    *   Если подходящих вопросов не найдено ни в БД, ни в файлах, и генерация отключена или недоступна, создаются простые шаблонные вопросы-заглушки ("Опишите ключевое понятие...").

### 2. Генерация уникальных вопросов (LLM)

Если существующий вопрос не найден (или система настроена на приоритетную генерацию), запускается процесс создания нового вопроса через OpenAI.

**Этапы генерации:**
1.  **Получение контекста**:
    *   Извлекается название темы (`title`) из Neo4j по `topic_uid`.
2.  **Определение типа вопроса**:
    *   Случайным образом выбирается тип: `single_choice`, `numeric`, `free_text`, `boolean`.
3.  **Детекция визуализации**:
    *   Проверяется название темы на наличие ключевых слов (геометрия, графики).
    *   Если тема визуальная, активируется режим `is_visual=True`.
4.  **Формирование промпта**:
    *   В LLM отправляется запрос с указанием темы, типа вопроса, целевой аудитории и требований к формату JSON.
    *   Если `is_visual=True`, добавляются инструкции по генерации координат и параметров отображения.
5.  **Обработка ответа**:
    *   Полученный JSON валидируется.
    *   Присваивается уникальный ID (`Q-GEN-...`).
    *   Если есть визуализация, данные проверяются через модель `VisualizationData`.
6.  **Результат**:
    *   Возвращается готовый объект `QuestionDTO`, который сохраняется в сессии (но пока не сохраняется в базу знаний как постоянный узел).

## Примеры ответов API

### 1. Ответ `/start` (JSON)

```json
{
  "items": [
    {
      "question_uid": "Q-GEN-a1b2c3d4",
      "subject_uid": "",
      "topic_uid": "topic_geometry_01",
      "type": "single_choice",
      "prompt": "Найдите площадь треугольника с вершинами в точках (0,0), (4,0) и (0,3).",
      "options": [
        {"option_uid": "opt_1", "text": "6", "is_correct": true},
        {"option_uid": "opt_2", "text": "12", "is_correct": false},
        {"option_uid": "opt_3", "text": "7", "is_correct": false},
        {"option_uid": "opt_4", "text": "5", "is_correct": false}
      ],
      "meta": {
        "difficulty": 0.5,
        "skill_uid": "",
        "generated": true
      },
      "is_visual": true,
      "visualization": {
        "type": "geometric_shape",
        "coordinates": [
          {"x": 0, "y": 0},
          {"x": 4, "y": 0},
          {"x": 0, "y": 3}
        ],
        "params": {
          "color": "blue",
          "labels": ["A", "B", "C"]
        }
      }
    }
  ],
  "meta": {
    "assessment_session_id": "sess_12345678"
  }
}
```

### 2. Ответ `/next` (Server-Sent Events)

Событие `question` в потоке данных:

```text
event: question
data: {
  "items": [
    {
      "question_uid": "Q-GEN-e5f6g7h8",
      "subject_uid": "",
      "topic_uid": "topic_functions_02",
      "type": "numeric",
      "prompt": "Определите значение функции y = x^2 в точке x = 2.",
      "options": [],
      "meta": {
        "difficulty": 0.6,
        "skill_uid": "",
        "generated": true
      },
      "is_visual": true,
      "visualization": {
        "type": "graph",
        "coordinates": {
          "function": "x^2",
          "range_x": [-5, 5],
          "range_y": [0, 25]
        },
        "params": {
          "grid": true,
          "highlight_point": {"x": 2, "y": 4}
        }
      }
    }
  ],
  "meta": {}
}
```
