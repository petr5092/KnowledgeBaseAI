# Спецификация Системы Визуализации и Генерации Вопросов (v2.0)

Настоящий документ описывает архитектуру и требования к обновленной системе визуализации, направленной на устранение проблем масштабирования, наложения объектов и обеспечение строгой согласованности между текстом вопроса и его графическим представлением.

---

## 1. Система Координат и Позиционирования (Visualization Engine)

### 1.1. Логическая Декартова Система (Logical Space)
Для упрощения генерации и понимания, система использует **стандартную школьную декартову систему координат**:
- **Центр (Origin)**: Точка `(0, 0)` является центром сцены.
- **Диапазон осей**:
  - Ось X: от `-5` (слева) до `5` (справа).
  - Ось Y: от `-5` (снизу) до `5` (сверху).
- **Целочисленность**: Координаты должны быть преимущественно **целыми числами** (Integers: -5, -4, ... 0, ... 5) для чистоты отображения. Дробные значения (0.5) допускаются при необходимости.

### 1.2. Физическая Нормализация (Mapping to Canvas)
Все логические координаты автоматически преобразуются в физическое пространство холста `[0, 10]`:
- **Mapping**: Логическая точка `(0, 0)` -> Физическая точка `(5, 5)`.
- **Formula**: `Physical_X = Logical_X + 5`, `Physical_Y = Logical_Y + 5`.
- **Scaling**: Если сгенерированные объекты выходят за пределы `[-5, 5]`, система автоматически масштабирует их (shrink), сохраняя центр `(0,0)` в точке `(5,5)`.

### 1.3. Предотвращение Наложений (Collision Avoidance)
- **Ограничение количества объектов**: МАКСИМУМ **3** объекта на одной сцене (Constraint: `MAX_OBJECTS = 3`).
- **Минимальная дистанция**: Между любыми несвязанными вершинами или объектами должно быть расстояние не менее `1.0` единицы.
- **Алгоритм Repel**:
    - Если расстояние между объектами `d < 1.0`, применить вектор расталкивания (repulsion vector) от центра `(5, 5)`.
    - Логировать конфликт, если после 5 итераций расталкивания наложение сохраняется.

---

## 2. Генерация Вопросов (Adaptive Question Engine)

### 2.1. Анализ Темы и Пререквизитов
Перед генерацией вопроса система обращается к графу Neo4j:
1.  **Fetch Context**: Получить текущую тему `Topic` и все связи `[:REQUIRES]->(PrereqTopic)`.
2.  **Prereq Check**: Проверить уровень мастерства (`mastery`) по каждому пререквизиту.
    - Если `mastery(prereq) < 0.6`, генератор принудительно включает элементы из пререквизита в условие задачи для повторения.

### 2.2. Адаптивная Сложность
Уровень сложности (`difficulty` от 1 до 10) корректируется динамически:

| Фактор | Влияние на сложность |
| :--- | :--- |
| Предыдущий ответ верный | +1 уровень |
| Предыдущий ответ неверный | -1 уровень |
| Время ответа < 10 сек (Fast) | +0.5 (Бонус за уверенность) |
| Время ответа > 60 сек (Slow) | -0.5 (Штраф за неуверенность) |
| История ошибок (Last 3) | Если 2 ошибки подряд по одной подтеме -> Сброс сложности на -2 |

### 2.3. Согласованность (Consistency Check)
**Критическое требование**: Содержание вопроса должно **ВСЕГДА** соответствовать визуализации.

#### 2.3.1. Алгоритм Атомарной Синхронизации (Atomic Sync)
Система рассматривает текст и графику как единый неделимый объект.

1.  **Label Consistency (Проверка меток)**:
    - Backend парсит текст вопроса на наличие ссылок на точки (латинские буквы A-Z).
    - **Правило**: Любая точка, упомянутая в тексте (например, "Треугольник ABC"), **ОБЯЗАНА** присутствовать в массиве `visualization.objects` с соответствующим `label`.
    - **Action**: Если метка найдена в тексте, но отсутствует в визуализации -> Автоматический перезапуск генерации (Retry Loop).

2.  **Math Consistency Proof (Доказательство корректности)**:
    - LLM обязана вернуть поле `math_consistency_proof` в JSON ответе.
    - **Пример**: "Координаты A(0,0) и B(0,6) выбраны так, чтобы расстояние AB равнялось 6, как указано в условии."
    - Это заставляет модель "подумать" перед генерацией, снижая вероятность галлюцинаций.

3.  **Integer Coordinates (Целочисленность)**:
    - Все координаты (`x`, `y`) автоматически округляются до ближайшего **0.5** или целого числа в `GeometryEngine`.
    - Это предотвращает появление артефактов вроде `4.4666667` и обеспечивает "чистый" вид графиков.

#### 2.3.2. Валидация "is_visual"
- Если `is_visual: false`, система использует Regex (включая поддержку буквы 'ё') для удаления любых ссылок на изображения ("на рисунке", "см. рис", "изображён").
- Это гарантирует, что чисто текстовые задачи не будут сбивать пользователя с толку отсутствующей картинкой.

---

## 3. Система Оценки Мастерства (Mastery System)

### 3.1. Метрика Mastery Score
Показатель мастерства рассчитывается по взвешенной формуле:

```python
Mastery = (w1 * Accuracy) + (w2 * Complexity) + (w3 * SpeedFactor) + (w4 * Consistency)
```

Где:
- **Accuracy (Точность)**: % правильных ответов (окно: последние 10 вопросов).
- **Complexity (Сложность)**: Средняя сложность решенных задач (нормализованная 0..1).
- **SpeedFactor**: `1.0`, если ср. время < 30с, иначе убывает до `0.5`.
- **Consistency**: Бонус за серию правильных ответов подряд.

*Веса по умолчанию*: `w1=0.5, w2=0.3, w3=0.1, w4=0.1`.

### 3.2. Визуализация Прогресса
- **Radar Chart**: Отображение мастерства по подтемам (например, "Теория", "Вычисления", "Визуализация").
- **Timeline**: График изменения `Mastery` во времени для отслеживания динамики обучения.

---

## 4. Технические Требования

### 4.1. Визуальные Индикаторы
JSON визуализации должен поддерживать поле `indicators`:
```json
"indicators": [
  {"type": "arrow", "from": {"x": 2, "y": 2}, "to": {"x": 8, "y": 2}, "label": "a = 6"},
  {"type": "angle_arc", "center": {"x": 2, "y": 2}, "radius": 0.5, "label": "30°"}
]
```

### 4.2. Анимация
- **Fade-in**: Объекты появляются последовательно (delay 200ms) для снижения когнитивной нагрузки.
- **No Overlap**: Анимация не должна создавать временных наложений.

### 4.3. Логирование и Мониторинг
- **Logger**: `app.services.visualization.logger`
- **Event**: `VISUALIZATION_CONFLICT`
- **Payload**: `{ "topic_uid": "...", "shapes_count": 3, "conflict_type": "overlap", "coordinates": [...] }`

---

## 5. Тестирование и Валидация

### 5.1. Unit-тесты (Positioning)
Необходимо реализовать тесты для проверки `GeometryEngine`. Пример реализации на `pytest`:

```python
def test_normalization_bounds():
    shapes = [
        {"points": [{"x": 15, "y": 20}, {"x": -5, "y": 0}]}
    ]
    normalized = GeometryEngine.normalize(shapes)
    for shape in normalized:
        for p in shape["points"]:
            assert 0 <= p["x"] <= 10
            assert 0 <= p["y"] <= 10

def test_centering():
    # Создаем фигуру со смещенным центром
    # Note: Bounding box center check, not centroid of points
    shapes = [{"points": [{"x": 0, "y": 0}, {"x": 2, "y": 0}, {"x": 1, "y": 1}]}]
    normalized = GeometryEngine.normalize(shapes)
    
    xs = [p["x"] for p in normalized[0]["points"]]
    ys = [p["y"] for p in normalized[0]["points"]]
    bbox_cx = (min(xs) + max(xs)) / 2
    bbox_cy = (min(ys) + max(ys)) / 2
    
    assert abs(bbox_cx - 5.0) < 0.1
    assert abs(bbox_cy - 5.0) < 0.1

def test_max_objects():
    shapes = [{"id": i} for i in range(4)]
    with pytest.raises(ValueError, match="Too many objects"):
        GeometryEngine.validate(shapes)
```

### 5.2. Интеграционные Тесты (Consistency)
- **Scenario**: Сгенерировать 50 вопросов.
- **Check**: Парсинг текста вопроса (Regex поиск чисел) vs Вычисление параметров фигур из JSON.
- **Threshold**: Расхождение не более 5% (допуск на округление).

### 5.3. Тестовые Случаи (Test Cases)
1.  **Level 1 (Easy)**: Одна фигура (Квадрат), центр (5,5), вопрос на периметр.
2.  **Level 5 (Medium)**: Две фигуры (Треугольник и Описанная окружность), проверка на пересечения.
3.  **Level 10 (Hard)**: График функции + Касательная (Line), проверка точности точки касания.

---

## Примеры JSON (v2.0)

### Геометрическая задача (Треугольник)
```json
{
  "type": "geometric_shape",
  "canvas": {"width": 10, "height": 10},
  "coordinates": [
    {
      "type": "polygon",
      "label": "ABC",
      "color": "#4A90E2",
      "points": [
        {"x": 2, "y": 2},   // A
        {"x": 8, "y": 2},   // B
        {"x": 5, "y": 8}    // C
      ]
    }
  ],
  "indicators": [
    {"type": "dimension", "start": {"x": 2, "y": 1.5}, "end": {"x": 8, "y": 1.5}, "text": "6 см"}
  ]
}
```
