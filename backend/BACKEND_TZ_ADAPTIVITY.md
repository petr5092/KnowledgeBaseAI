# Техническое задание (ТЗ) на улучшение адаптивности тестирования и генерации Roadmap

## 1. Контекст и Проблема
На текущий момент процесс перехода от **Тестирования** к **Дорожной карте (Roadmap)** опирается исключительно на численный показатель `score` (0.0 - 1.0). 
Это приводит к потере контекста:
*   Система знает, что ученик сдал тему на 0.4 (плохо), но не знает *почему* (ошибки в вычислениях, незнание формул или непонимание концепции).
*   В результате Roadmap предлагает общие пререквизиты (например, "Сложение"), хотя проблема могла быть узкой (например, "Дискриминант").
*   Пользователь ощущает диссонанс: "Я ошибался в уравнениях, зачем мне таблица умножения?".

## 2. Цель
Обеспечить **бесшовную связку** между выявленными пробелами в тестировании и узлами генерируемой дорожной карты. Roadmap должен строиться как "лечебный план" для конкретных ошибок пользователя.

---

## 3. Функциональные требования

### 3.1. Модификация API Тестирования (`/v1/assessment/next`)
Необходимо расширить возвращаемый объект `analytics` при завершении теста.

**Текущее состояние:**
Возвращает текстовые `gaps` (для чтения человеком).

**Требуемое состояние:**
Возвращать структурированные данные для машины:
```json
{
  "event": "done",
  "data": {
    "analytics": {
      "knowledge_profile": {
        "conceptual_errors": ["quadratic_formula_sign", "factoring_grouping"],
        "procedural_errors": ["arithmetic_calculation"],
        "mastered_concepts": ["identifying_coefficients"]
      },
      "recommended_focus_topics": ["TOP-FACTORING-01", "TOP-DISCRIMINANT-02"] 
    }
  }
}
```

### 3.2. Модификация API Roadmap (`/v1/engine/roadmap`)
Изменить контракт входящих данных, чтобы принимать детальную аналитику.

**Request Body (Новое поле `assessment_context`):**
```json
{
  "subject_uid": "MATH-FULL-V1",
  "focus_topic_uid": "TOP-QUADRATIC-EQ",
  "assessment_context": {
    "session_id": "sess-uuid...",
    "score": 0.45,
    "detected_gaps": ["quadratic_formula_sign", "factoring_grouping"], // Из шага 3.1
    "difficulty_reached": 6.5 // Максимальная сложность, на которой пользователь отвечал верно
  },
  "user_context": { ... }
}
```

### 3.3. Логика генерации (Engine)
Обновить промпт LLM и логику выборки узлов в `engine.py`.

1.  **Приоритизация по ошибкам**: 
    *   Если в `detected_gaps` есть специфические теги, искать соответствующие подтемы в графе или генерировать узлы специально под них.
    *   *Пример*: Если ошибка в "Знаках дискриминанта", создать узел "Работа со знаками в формуле корней".
2.  **Учет уровня сложности**:
    *   Если `difficulty_reached` был высоким (например, 8/10), но `score` средний — предлагать углубленные темы, а не базовые.
    *   Если `difficulty_reached` низкий (<4/10) — предлагать фундаментальные пререквизиты (distance=1).
3.  **Структура из 8 узлов**:
    *   1-2 узла: Фундамент (устранение критических пробелов из `detected_gaps`).
    *   3-5 узлов: Основная тема (Practice Loop) с акцентом на слабые места.
    *   6-8 узлов: Расширение/Закрепление (если score позволяет).

## 4. План реализации

1.  **Backend (Assessment)**: 
    *   Обновить системный промпт в `assessment.py`, чтобы LLM возвращал JSON с полем `knowledge_profile` (теги ошибок).
2.  **Backend (Roadmap Schema)**: 
    *   Обновить Pydantic модель `RoadmapRequest` в `schemas/roadmap.py`.
3.  **Backend (Engine Logic)**: 
    *   В `engine.py` извлечь `assessment_context`.
    *   Модифицировать Cypher-запрос: искать темы не только по связям, но и по тегам (если реализовано) или передавать контекст ошибок в LLM для фильтрации.
    *   Обновить промпт генерации Roadmap: "User failed specific concepts: [X, Y]. Build a path to fix EXACTLY these issues first."
4.  **Frontend**: 
    *   Прокинуть данные из ответа `/assessment/next` в запрос `/engine/roadmap`.

## 5. Критерии приемки (DoD)
1.  Если пользователь ошибается в **знаках**, Roadmap содержит узел, посвященный **арифметике знаков** или **формулам**, а не абстрактную "Алгебру".
2.  API Roadmap принимает объект аналитики без ошибок валидации.
3.  Количество узлов строго равно 8.
4.  Сценарий "Тест -> Roadmap" выглядит логичным и персонализированным (связность > 90% по оценке эксперта).
