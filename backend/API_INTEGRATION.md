
# Документация по интеграции адаптивного обучения (StudyNinja Backend)

Этот документ описывает полный цикл взаимодействия с API KnowledgeBaseAI для реализации сценария адаптивного обучения: выбор темы -> тестирование -> аналитика -> построение дорожной карты. Также включена информация о логике генерации данных и алгоритмах рекомендаций.

---

## 1. Общий сценарий (User Flow)

1.  **Выбор темы (`/v1/engine/topics/available`)**:
    *   Клиент запрашивает список тем.
    *   Система фильтрует темы по классу (`user_class`) или возрасту (`age`) пользователя.
    *   Пользователь выбирает одну тему (`topic_uid`).

2.  **Входное тестирование (`/v1/assessment/start` -> `/v1/assessment/next`)**:
    *   Клиент начинает сессию оценки знаний.
    *   Система адаптивно подбирает вопросы (сложнее/легче) в зависимости от ответов.
    *   В конце выдается аналитика (пробелы в знаниях, рекомендации).

3.  **Построение Roadmap (`/v1/engine/roadmap`)**:
    *   Если пользователь решил изучать тему, строится карта из 5 узлов (подтем).
    *   Каждый узел содержит микро-уроки по методологии "I Do / We Do / You Do" и финальный тест.
    *   Рассчитывается `max_score` (баллы) для геймификации.

4.  **Рекомендации "Что учить дальше?" (`/v1/engine/next-best-topic`)**:
    *   Если у пользователя нет конкретной цели, система советует темы на основе графа зависимостей (Need, Importance, Unlock Impact).

---

## 2. Спецификация API

### 2.1. Получение списка тем
Возвращает список тем, доступных пользователю, с учетом его уровня.

*   **URL**: `/v1/engine/topics/available`
*   **Method**: `POST`
*   **Логика фильтрации**:
    *   **По классу**: В базе Neo4j у тем есть поля `user_class_min` и `user_class_max`. Система фильтрует темы по `user_class` из `user_context`.
    *   **По учебной программе (Curriculum)**: Если передан `curriculum_code`, система дополнительно фильтрует темы, оставляя только те, что входят в указанную программу (включая их пререквизиты). Темы, не входящие в программу, исключаются.
*   **Request Body**:
    ```json
    {
      "subject_uid": "MATH-FULL-V1",
      "curriculum_code": "RU-MATH-10", // Опционально: Код учебной программы для фильтрации
      "user_context": {
        "user_class": 10,   // Приоритет 1: Явный класс
        "age": 16,          // Приоритет 2: Возраст (если класс не указан)
        "attributes": {     // Legacy поддержка
          "grade": 10
        }
      }
    }
    ```
*   **Response**:
    ```json
    {
      "items": [
        {
          "topic_uid": "TOP-REGR-ANALYZ-...",
          "title": "Регрессионный анализ",
          "user_class_min": 10,
          "user_class_max": 11,
          "difficulty_band": "standard"
        }
      ]
    }
    ```

### 2.2. Начало тестирования
Создает сессию адаптивного тестирования.

*   **URL**: `/v1/assessment/start`
*   **Method**: `POST`
*   **Особенности**:
    *   **Admin/Test Mode**: Если передать `user_class: 0` (или меньше), проверка доступности темы отключается (можно тестировать любой контент).
    *   В обычном режиме проверяется, соответствует ли класс пользователя диапазону темы.
*   **Request Body**:
    ```json
    {
      "subject_uid": "MATH-FULL-V1",
      "topic_uid": "TOP-SVOISTVA-...",
      "user_context": {
        "user_class": 0, // 0 для обхода ограничений уровня
        "age": 0
      }
    }
    ```
*   **Response**:
    ```json
    {
      "items": [
        {
          "question_uid": "Q-123...",
          "type": "free_text",
          "prompt": "Текст первого вопроса...",
          "options": [],
          "meta": { "difficulty": 0.5 }
        }
      ],
      "meta": {
        "assessment_session_id": "sess-uuid-..." // Сохранить для /next
      }
    }
    ```

### 2.3. Процесс тестирования (Streaming)
Отправка ответа и получение следующего шага.

*   **URL**: `/v1/assessment/next`
*   **Method**: `POST`
*   **Format**: Server-Sent Events (SSE)
*   **Request Body**:
    ```json
    {
      "assessment_session_id": "sess-uuid-...",
      "question_uid": "Q-123...",
      "answer": {
        "text": "Ответ пользователя",
        "selected_option_uids": []
      }
    }
    ```
*   **Response Events**:
    1.  `event: ack` — Ответ принят.
    2.  `event: question` — Пришел следующий вопрос (адаптивная логика повысила/понизила сложность).
    3.    `event: done` — Тест завершен. Приходит JSON с аналитикой.
        *   **Важно**: Поле `mastery.score` — это **взвешенная оценка**. Она учитывает не только правильность ответов, но и **сложность** (Difficulty) вопросов. 100% правильных ответов на легкие вопросы не дадут score 1.0.
        ```json
        {
          "topic_uid": "TOP-...",
          "mastery": { "score": 0.85 }, // Взвешенная оценка (учитывает сложность)
          "analytics": {
            "gaps": ["Базовое понимание требует закрепления"], // Выявленные пробелы
            "recommended_focus": "Переходить к следующей теме", // Рекомендация
            "strength": "Хорошая скорость ответов"
          }
        }
        ```

### 2.4. Дорожная карта (Roadmap)
Генерация детального плана обучения по теме.

*   **URL**: `/v1/engine/roadmap`
*   **Method**: `POST`
*   **Логика построения**:
    *   **Канонический граф**: Backend использует структуру графа (темы и зависимости) из базы знаний (Knowledge Base) как скелет.
    *   **Динамическая генерация контента**: Микро-уроки (`units`) **не хранятся статически** в графе. Они генерируются или подтягиваются Backend-сервисом в момент запроса ("On-the-fly hydration") для обеспечения актуальности и адаптивности.
    *   **Контекстная генерация**: Если передан `focus_topic_uid` (тема, которую пользователь только что сдавал), алгоритм приоритизирует:
        *   **Remediation**: Если оценка < 0.6, включаются **пререквизиты** этой темы (чтобы закрыть пробелы).
        *   **Focus Loop**: Если оценка 0.6 - 0.85, система строит карту **по этой же теме** для устранения пробелов (Practice Loop).
        *   **Progression**: Только при **полном усвоении** текущей темы (Score > 0.85 на вопросах высокой сложности). Система предлагает углубление или следующие логические темы.
    *   Возвращает **динамическое количество узлов** (обычно 5-8), зависящее от графа зависимостей (Prerequisites) для целевой темы.
        *   Алгоритм обходит граф пререквизитов в глубину, чтобы выстроить логическую цепочку от базовых понятий к целевой теме.
        *   Количество узлов не фиксировано и определяется сложностью темы и количеством необходимых предварительных знаний.
    *   **Структура узла**:
        *   `units` (Микро-уроки): Список сгруппированных уроков. Каждый элемент содержит секции `i_do`, `we_do`, `you_do`.
        *   Финальный тест узла: `lesson_test` (3 балла).
    *   **Max Score**: Рассчитывается суммарно для всей карты и для каждого узла.
*   **Request Body**:
    ```json
    {
      "subject_uid": "MATH-FULL-V1",
      "focus_topic_uid": "TOP-SELECTED-TOPIC", // ВАЖНО: Тема, по которой только что прошли тест
      "current_progress": {
        "TOP-SELECTED-TOPIC": 0.45, // Результат теста (0.0 - 1.0)
        "TOP-PREREQ-1": 1.0
      },
      "user_context": { "user_class": 10 }
    }
    ```
*   **Response**:
    > **Примечание**: Структура ответа сохраняет совместимость с StudyNinja, но поле `units` теперь формируется динамически.

    ```json
    {
      "max_score": 30, // Сумма баллов всех узлов (расчетное значение)
      "nodes": [
        {
          "topic_uid": "TOP-SUBTOPIC-1",
          "title": "Подтема 1 (Пререквизит)",
          "description": "Описание, сгенерированное ИИ",
          "status": "available",
          "max_score": 6, // 1+1+1 (уроки) + 3 (тест)
          "current_score": 0.0,
          "progress_percentage": 0.0,
          "units": [
            // ВАЖНО: Этот массив генерируется бэкендом, его нет в статичном roadmap.json
            {
               "order": 1,
               "title": "Урок 1",
               "i_do": { "type": "lesson_i_do", "title": "Изучение...", "payload": {...} },
               "we_do": { "type": "lesson_we_do", "title": "Практика...", "payload": {...} },
               "you_do": { "type": "lesson_you_do", "title": "Задание...", "payload": {...} }
            }
          ],
          "final_test": { "type": "lesson_test", "title": "Финальный тест", "payload": {...} }
        }
        // ... еще 4 узла
      ]
    }
    ```

### 2.5. Рекомендации (Next Best Topic)
Подбор следующей темы для изучения (если нет конкретной цели).

*   **URL**: `/v1/engine/next-best-topic`
*   **Method**: `POST`
*   **Алгоритм**:
    *   Фильтрует темы, где пререквизиты (Prerequisites) выполнены > 70%.
    *   Ранжирует по формуле: `Score = (1 - Mastery) * (1 + alpha * Importance + beta * Unlock_Impact)`.
    *   **Importance**: Число тем, зависящих от данной напрямую.
    *   **Unlock Impact**: Число тем, которые откроются в будущем (вся ветка графа).

---

## 3. Генерация и структура данных

### 3.1. Классификация тем (`fix_topic_classes.py`)
Скрипт миграции, который проставляет `user_class_min` / `user_class_max` в Neo4j.
*   Использует словарь ключевых слов (стемминг) для маппинга тем на классы (например, "Интеграл" -> 11 класс, "Сложение" -> 1-4 класс).
*   Если тема не попадает под правила, ставится дефолт (7-11 класс).
*   **Запуск**: `docker exec ... python3 /app/fix_topic_classes.py`

### 3.2. Генерация контента (Backend Dynamic Layer)
Теперь ответственность за контент (микро-уроки, вопросы) лежит на Backend-сервисе, а не на репозитории Knowledge Base.

*   **Knowledge Base (`roadmap.json`)**: Определяет только **структуру графа** (Topics), метаданные (Title, Description, Difficulty) и зависимости (Prerequisites). Это "скелет" предмета.
    > **Пример структуры roadmap.json (Canonical):**
    ```json
    {
      "version": "2.0",
      "subject_uid": "MATH-FULL-V1",
      "nodes": [
        {
          "topic_uid": "TOP-SLOZHENIE-...",
          "title": "Сложение и вычитание",
          "description": "Сложение и вычитание - основные операции...",
          "metadata": {
            "difficulty_level": 1,
            "keywords": ["арифметика", "база"]
          },
          "prerequisites": [] 
        },
        {
          "topic_uid": "TOP-UMNOZHENIE-...",
          "title": "Умножение и деление",
          "description": "Ключевые арифметические операции...",
          "metadata": {
            "difficulty_level": 2
          },
          "prerequisites": ["TOP-SLOZHENIE-..."]
        }
      ]
    }
    ```
*   **Backend Hydration**: При запросе `/v1/engine/roadmap` сервис:
    1.  Читает структуру темы из графа.
    2.  Генерирует или извлекает из кэша контент уроков (I Do / We Do / You Do).
    3.  Собирает финальный JSON для клиента.

### 3.3. Влияние на тестирование (Assessment)
Изменение структуры `roadmap.json` также меняет подход к адаптивному тестированию:

*   **Независимость от статики**: Вопросы больше не привязаны жестко к `quiz_id` в JSON-файле.
*   **Динамическая выборка**: При запросе `/v1/assessment/start` бэкенд обращается к **изолированному банку вопросов** (Question Bank, например, Vector DB или отдельная таблица) или генератору. Вопросы выбираются по `topic_uid`, но физически **не хранятся в графе навигации**.
*   **Пайплайн генерации и валидации**:
    *   Генератор вопросов **обязан присваивать теги** каждому вопросу (как минимум: `topic_uid`, `difficulty`, `keywords`).
    *   Перед загрузкой в базу (например, Qdrant) вопросы проходят автоматическую **валидацию (True/False system)**.
    *   **Только валидные вопросы** индексируются и становятся доступными для API. Невалидные отбрасываются или отправляются на доработку.
*   **Гибкость**: Это позволяет обновлять базу вопросов без изменения структуры графа знаний и релизов `roadmap.json`.

### 3.4. Структура графа (Neo4j)
Граф в Neo4j теперь сфокусирован на топологии знаний.

*   **Nodes**: `Topic` (канонические узлы).
*   **Relationships**:
    *   `(:Topic)-[:PREREQ]->(:Topic)` — зависимость знаний (критически важно для `next-best-topic`).
    *   `(:Subject)-[:CONTAINS]->(:Topic)` — иерархия предмета.
*   **Важно**: Узлы типа `LessonUnit` (уроки, тесты) **отсутствуют** в графе Neo4j. Они существуют только в рантайме API ответа.
