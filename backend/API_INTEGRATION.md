
# Документация по интеграции адаптивного обучения (StudyNinja Backend)

Этот документ описывает полный цикл взаимодействия с API KnowledgeBaseAI для реализации сценария адаптивного обучения: выбор темы -> тестирование -> аналитика -> построение дорожной карты. Также включена информация о логике генерации данных и алгоритмах рекомендаций.

---

## 1. Общий сценарий (User Flow)

1.  **Выбор темы (`/v1/engine/topics/available`)**:
    *   Клиент запрашивает список тем.
    *   Система фильтрует темы по классу (`user_class`) или возрасту (`age`) пользователя.
    *   Пользователь выбирает одну тему (`topic_uid`).

2.  **Входное тестирование (`/v1/assessment/start` -> `/v1/assessment/next`)**:
    *   Клиент начинает сессию оценки знаний.
    *   Система адаптивно подбирает вопросы (сложнее/легче) в зависимости от ответов.
    *   В конце выдается аналитика (пробелы в знаниях, рекомендации).

3.  **Построение Roadmap (`/v1/engine/roadmap`)**:
    *   Если пользователь решил изучать тему, строится карта из 5 узлов (подтем).
    *   Каждый узел содержит микро-уроки по методологии "I Do / We Do / You Do" и финальный тест.
    *   Рассчитывается `max_score` (баллы) для геймификации.

4.  **Рекомендации "Что учить дальше?" (`/v1/engine/next-best-topic`)**:
    *   Если у пользователя нет конкретной цели, система советует темы на основе графа зависимостей (Need, Importance, Unlock Impact).

---

## 2. Спецификация API

### 2.1. Получение списка тем
Возвращает список тем, доступных пользователю, с учетом его уровня.

*   **URL**: `/v1/engine/topics/available`
*   **Method**: `POST`
*   **Логика фильтрации**:
    *   В базе Neo4j у тем есть поля `user_class_min` и `user_class_max` (например, "Тригонометрия" — 10-11 класс).
    *   Система берет `user_class` из `user_context`. Если его нет, вычисляет класс из `age` (Возраст - 6).
    *   Возвращаются только те темы, которые подходят под диапазон.
*   **Request Body**:
    ```json
    {
      "subject_uid": "MATH-FULL-V1",
      "user_context": {
        "user_class": 10,   // Приоритет 1: Явный класс
        "age": 16,          // Приоритет 2: Возраст (если класс не указан)
        "attributes": {     // Legacy поддержка
          "grade": 10
        }
      }
    }
    ```
*   **Response**:
    ```json
    {
      "items": [
        {
          "topic_uid": "TOP-REGR-ANALYZ-...",
          "title": "Регрессионный анализ",
          "user_class_min": 10,
          "user_class_max": 11,
          "difficulty_band": "standard"
        }
      ]
    }
    ```

### 2.2. Начало тестирования
Создает сессию адаптивного тестирования.

*   **URL**: `/v1/assessment/start`
*   **Method**: `POST`
*   **Особенности**:
    *   **Admin/Test Mode**: Если передать `user_class: 0` (или меньше), проверка доступности темы отключается (можно тестировать любой контент).
    *   В обычном режиме проверяется, соответствует ли класс пользователя диапазону темы.
*   **Request Body**:
    ```json
    {
      "subject_uid": "MATH-FULL-V1",
      "topic_uid": "TOP-SVOISTVA-...",
      "user_context": {
        "user_class": 0, // 0 для обхода ограничений уровня
        "age": 0
      }
    }
    ```
*   **Response**:
    ```json
    {
      "items": [
        {
          "question_uid": "Q-123...",
          "type": "free_text",
          "prompt": "Текст первого вопроса...",
          "options": [],
          "meta": { "difficulty": 0.5 }
        }
      ],
      "meta": {
        "assessment_session_id": "sess-uuid-..." // Сохранить для /next
      }
    }
    ```

### 2.3. Процесс тестирования (Streaming)
Отправка ответа и получение следующего шага.

*   **URL**: `/v1/assessment/next`
*   **Method**: `POST`
*   **Format**: Server-Sent Events (SSE)
*   **Request Body**:
    ```json
    {
      "assessment_session_id": "sess-uuid-...",
      "question_uid": "Q-123...",
      "answer": {
        "text": "Ответ пользователя",
        "selected_option_uids": []
      }
    }
    ```
*   **Response Events**:
    1.  `event: ack` — Ответ принят.
    2.  `event: question` — Пришел следующий вопрос (адаптивная логика повысила/понизила сложность).
    3.    `event: done` — Тест завершен. Приходит JSON с аналитикой.
        *   **Важно**: Поле `mastery.score` — это **взвешенная оценка**. Она учитывает не только правильность ответов, но и **сложность** (Difficulty) вопросов. 100% правильных ответов на легкие вопросы не дадут score 1.0.
        ```json
        {
          "topic_uid": "TOP-...",
          "mastery": { "score": 0.85 }, // Взвешенная оценка (учитывает сложность)
          "analytics": {
            "gaps": ["Базовое понимание требует закрепления"], // Выявленные пробелы
            "recommended_focus": "Переходить к следующей теме", // Рекомендация
            "strength": "Хорошая скорость ответов"
          }
        }
        ```

### 2.4. Дорожная карта (Roadmap)
Генерация детального плана обучения по теме.

*   **URL**: `/v1/engine/roadmap`
*   **Method**: `POST`
*   **Логика построения**:
    *   **Контекстная генерация**: Если передан `focus_topic_uid` (тема, которую пользователь только что сдавал), алгоритм приоритизирует:
        *   **Remediation**: Если оценка < 0.6, включаются **пререквизиты** этой темы (чтобы закрыть пробелы).
        *   **Focus Loop**: Если оценка 0.6 - 0.85, система строит карту **по этой же теме** для устранения пробелов (Practice Loop).
        *   **Progression**: Только при **полном усвоении** текущей темы (Score > 0.85 на вопросах высокой сложности). Система предлагает углубление или следующие логические темы.
    *   Возвращает ровно **8 узлов** (подтем), отсортированных логически (сначала пререквизиты, потом целевая тема, потом следующие).
    *   **Структура узла**:
        *   `units` (Микро-уроки): Список сгруппированных уроков. Каждый элемент содержит секции `i_do`, `we_do`, `you_do`.
        *   Финальный тест узла: `lesson_test` (3 балла).
    *   **Max Score**: Рассчитывается суммарно для всей карты и для каждого узла.
*   **Request Body**:
    ```json
    {
      "subject_uid": "MATH-FULL-V1",
      "focus_topic_uid": "TOP-SELECTED-TOPIC", // ВАЖНО: Тема, по которой только что прошли тест
      "current_progress": {
        "TOP-SELECTED-TOPIC": 0.45, // Результат теста (0.0 - 1.0)
        "TOP-PREREQ-1": 1.0
      },
      "user_context": { "user_class": 10 }
    }
    ```
*   **Response**:
    ```json
    {
      "max_score": 30, // Сумма баллов всех узлов
      "nodes": [
        {
          "topic_uid": "TOP-SUBTOPIC-1",
          "title": "Подтема 1 (Пререквизит)",
          "description": "Описание, сгенерированное ИИ",
          "status": "available",
          "max_score": 6, // 1+1+1 (уроки) + 3 (тест)
          "current_score": 0.0,
          "progress_percentage": 0.0,
          "units": [
            {
               "order": 1,
               "title": "Урок 1",
               "i_do": { "type": "lesson_i_do", "title": "Изучение...", "payload": {...} },
               "we_do": { "type": "lesson_we_do", "title": "Практика...", "payload": {...} },
               "you_do": { "type": "lesson_you_do", "title": "Задание...", "payload": {...} }
            }
          ],
          "final_test": { "type": "lesson_test", "title": "Финальный тест", "payload": {...} }
        }
        // ... еще 4 узла
      ]
    }
    ```

### 2.5. Рекомендации (Next Best Topic)
Подбор следующей темы для изучения (если нет конкретной цели).

*   **URL**: `/v1/engine/next-best-topic`
*   **Method**: `POST`
*   **Алгоритм**:
    *   Фильтрует темы, где пререквизиты (Prerequisites) выполнены > 70%.
    *   Ранжирует по формуле: `Score = (1 - Mastery) * (1 + alpha * Importance + beta * Unlock_Impact)`.
    *   **Importance**: Число тем, зависящих от данной напрямую.
    *   **Unlock Impact**: Число тем, которые откроются в будущем (вся ветка графа).

---

## 3. Генерация и структура данных

### 3.1. Классификация тем (`fix_topic_classes.py`)
Скрипт миграции, который проставляет `user_class_min` / `user_class_max` в Neo4j.
*   Использует словарь ключевых слов (стемминг) для маппинга тем на классы (например, "Интеграл" -> 11 класс, "Сложение" -> 1-4 класс).
*   Если тема не попадает под правила, ставится дефолт (7-11 класс).
*   **Запуск**: `docker exec ... python3 /app/fix_topic_classes.py`

### 3.2. Генерация контента (`generate_content.py`)
Скрипт, который наполняет базу микро-уроками.
*   Генерирует JSONL-файлы с блоками `lesson_i_do`, `lesson_we_do`, `lesson_you_do`.
*   **Важно**: Контент привязывается к конкретным `topic_uid`, чтобы Roadmap выдавал релевантные уроки, а не случайные.
*   Загрузка в Neo4j происходит через `load_units.py`.

### 3.3. Структура графа (Neo4j)
*   **Nodes**: `Topic`, `LessonUnit` (типы: i_do, we_do, you_do, test).
*   **Relationships**:
    *   `(:Topic)-[:HAS_UNIT]->(:LessonUnit)` — привязка контента.
    *   `(:Topic)-[:PREREQ]->(:Topic)` — зависимость знаний.
    *   `(:Subject)-[:CONTAINS]->(:Topic)` — иерархия предмета.
