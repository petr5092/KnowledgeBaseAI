## Цели
- Реализовать умную (LLM) генерацию онтологии предмета по схеме Subject→Section→Subsection→Topic с явными PREREQ.
- Сгенерировать прикладной слой (Skills, Methods, ContentUnits, Examples, Errors) для каждой темы.
- Эндпоинт принимает {subject, language} и создаёт папку с JSONL-файлами, готовыми к импортy.

## Эндпоинт
- POST /kb/generate_smart
  - Вход: { subject: string, language: 'ru' | 'en', limits?: {sections?: number, topics_per_subsection?: number} }
  - Выход: { ok, base_dir, files: {name: count}, warnings?: [...], summary }

## LLM-пайплайн
1) Генерация разделов и подразделов (LLM):
   - Prompt: «Сформируй строгую онтологию предмета на языке {language}. Верни JSONL: {section, subsection}». Ограничить count.
2) Генерация тем с PREREQ на подраздел (LLM):
   - Prompt: «Для подраздела {subsection} верни JSONL с полями {title, prereqs[]}».
   - Инструкция: «Только логические пререквизиты. Без циклов. Дагограф».
3) Постобработка DAG:
   - Сопоставление названий → uid.
   - Проверка циклов; при обнаружении — авто-правка: удаление минимальных рёбер/повтор LLM-запроса при критических случаях.
4) Генерация навыков (LLM):
   - Prompt: «Навыки темы {topic} (title, definition), JSONL; 2–3 шт.».
5) Генерация методов (LLM):
   - Prompt: «Методы для навыка {skill} (title, method_text), JSONL; 2 шт.».
6) Теория и контент-единицы (LLM):
   - Prompt: «Краткая теория по теме {topic}» → ContentUnit(type='theory').
   - Prompt: «Ключевые понятия» → ContentUnit(type='concept').
   - Prompt: «Ключевые формулы (если релевантно)» → ContentUnit(type='formula').
   - Prompt: «2–3 пошаговых объяснения» → ContentUnit(type='lesson_step').
7) Примеры (LLM):
   - Prompt: «Учебные задачи по теме {topic}: JSONL {title, statement}».
8) Ошибки (LLM):
   - Prompt: «Типовые ошибки по {topic}: JSONL {title, error_text}».

## Запись JSONL
- Создание директории: kb/{language}/{slug(subject)}.
- Запись: subjects.jsonl, sections.jsonl, subsections.jsonl, topics.jsonl, topic_prereqs.jsonl, skills.jsonl, topic_skills.jsonl, methods.jsonl, skill_methods.jsonl, content_units.jsonl, examples.jsonl, error_*.jsonl.
- normalize_kb_dir(base_dir) → детерминизировать вывод.

## Изменения в коде
- jsonl_io.py:
  - get_subject_dir(subject_slug, language)
  - get_path_in(base_dir, name)
  - normalize_kb_dir(base_dir)
- builder.py:
  - Новые async-генераторы: generate_subsections_openai_async, generate_topics_with_prereqs_openai_async, generate_content_units_openai_async.
  - orchestrator generate_subject_with_llm(subject, language, limits?) — полный пайплайн.
- utils.py:
  - sync_from_jsonl_dir(base_dir) — импорт из указанной папки через Proposal Gate.
- api/kb.py:
  - POST /kb/generate_smart → вызывает orchestrator; опционально импортирует (по флагу).

## Надёжность
- Валидация DAG: авто-правка циклов.
- Ограничение размера (конфиг): секции/темы/юниты.
- Повтор LLM-запросов при пустых ответах.

## Тесты
- Моки LLM для unit-тестов: фиктивные ответы в RU/EN.
- Проверка: создана папка, файлы не пусты, PREREQ без циклов, импорт ops > N.

## Результат
- Эндпоинт «умной» генерации под любой предмет/язык.
- Полный комплект JSONL, готовый для загрузки в граф и дальнейшего reasoning/NBT/gaps.