## Цели
- Сгенерировать строгую онтологию предмета «Математика» по схеме Раздел → Подраздел → Тема, с явными логическими PREREQ и без циклов (DAG).
- Для каждой темы добавить прикладной слой: Skill, Concept, Formula, Errors, Examples.
- Сделать сборку идемпотентной, детерминированной и готовой к импортy через Proposal Gate (MERGE_NODE/REL: CONTAINS, PREREQ, USES_SKILL, HAS_UNIT, HAS_EXAMPLE).

## Обновления модели данных
- Ввести сущность Subsection (Подраздел) как отдельный узел:
  - JSONL: subsections.jsonl {uid, section_uid, title, description}.
  - Граф: Subject -[:CONTAINS]-> Section -[:CONTAINS]-> Subsection -[:CONTAINS]-> Topic.
- Расширить ContentUnit типами: concept, formula, theory, lesson_step.
- Использовать уже существующие JSONL файлы: subjects.jsonl, sections.jsonl, topics.jsonl, topic_prereqs.jsonl, skills.jsonl, topic_skills.jsonl, methods.jsonl, skill_methods.jsonl, content_units.jsonl, examples.jsonl, example_skills.jsonl, errors.jsonl, error_skills.jsonl, error_examples.jsonl.

## Изменения в билдере
- Добавить функции:
  - add_subsection(section_uid, title, description, uid?) → пишет в subsections.jsonl.
  - link_section_subsection(section_uid, subsection_uid) → не нужен отдельный файл: связь задаётся через поле section_uid у Subsection, а импорт сформирует CONTAINS.
  - add_topic_to_subsection(subsection_uid, title, description, uid?) → пишет topics.jsonl с полем section_uid=subsection_uid.
- Переписать add_lesson_step под ContentUnit lesson_step (оставить интерфейс, унифицировать payload).
- Ввести add_concept_unit(topic_uid, text) → ContentUnit(type='concept').
- Ввести add_formula_unit(topic_uid, latex_or_text) → ContentUnit(type='formula').
- Генерация Skill для каждой темы: создать 1–3 базовых навыка (например, «Понимание {Тема}», «Применение {Тема}») и связать через topic_skills.jsonl.
- Генерация Examples: минимум 1 учебный пример на тему (без внешних API), связать HAS_EXAMPLE.
- Генерация Errors: 1–2 типовые ошибки для темы, связать error_skills/error_examples по необходимости.

## Статический источник онтологии
- Встроить в builder.py константу MATHEMATICS_ONTOLOGY со структурой:
  - subject: «МАТЕМАТИКА»
  - sections: [
    {title, subsections: [ {title, topics: [ {title, prereqs: [titles]} ] } ] }
  ]
- Загружать итерируемо: создать subject → sections → subsections → topics; собирать карту {topic_title → uid} для разрешения prereqs.

## Построение PREREQ и проверка DAG
- После записи всех тем построить topic_prereqs.jsonl по карте соответствий.
- Добавить проверку ацикличности:
  - Собрать ориентированный граф тем.
  - Выполнить DFS/Kahn topological sort; при обнаружении цикла — логировать и пропускать проблемную дугу.

## Импорт в граф
- Обновить sync_from_jsonl, чтобы импортировать Subsection:
  - MERGE_NODE для Subsection.
  - CONTAINS: Subject→Section, Section→Subsection, Subsection→Topic.
  - Уже есть импорт CONTAINS для Section→Topic; расширим для Subsection.
  - Остальные рёбра: PREREQ, USES_SKILL, HAS_UNIT, HAS_EXAMPLE, TARGETS/MEASURES — оставляем без изменений.
- Обеспечить идемпотентность: использовать rewrite_jsonl для пересборки и normalize_kb в конце.

## Наполнение прикладного слоя
- Для каждой темы:
  - add_concept_unit(topic_uid, краткое определение).
  - add_formula_unit(topic_uid, ключевые формулы (если релевантно)).
  - add_lesson_step(topic_uid, role='tutor', короткий шаг объяснения).
  - add_example(title=f"Пример: {Тема}", statement=краткая постановка, topic_uid).
  - add_error(title=f"Типовые ошибки: {Тема}", error_text=краткий список).
  - 1–3 skills + link_topic_skill.
- Без вызова OpenAI: наполнение минимально-текстовое, детерминированное.

## Идентификаторы и уникальность
- Использовать make_uid с префиксами: SUB/SEC/SUBSEC/TOP/SKL/MET/UNIT/EX/ERR.
- Для TOP uid учитывать контекст (например, TOP-{subsec}-{slug(title)}) чтобы избежать коллизий.

## Точки интеграции и совместимость
- builder.py: новые функции и основной сценарий build_mathematics_ontology().
- jsonl_io.py: добавить get_path('subsections.jsonl') и normalize_kb учесть новый файл.
- utils.sync_from_jsonl(): расширить импорт Subsection.
- Ничего не ломаем в существующих API; дорожная карта и reasoning будут работать благодаря PREREQ и CONTAINS.

## Проверка и тесты
- Юнит-тесты:
  - Проверка построения онтологии: количество разделов/подразделов/тем.
  - Проверка PREREQ и ацикличности.
  - Проверка импорта: наличие нужных связей CONTAINS/PREREQ.
  - Проверка наличия прикладных слоёв (ContentUnit, Skills, Examples, Errors) на каждой теме.
- Сухой прогон без коммита, затем прогон импорта в тестовой БД.

## План внедрения
1) Добавить Subsection в JSONL/билдер.
2) Реализовать MATHEMATICS_ONTOLOGY и build_mathematics_ontology().
3) Сгенерировать прикладной слой для каждой темы.
4) DAG-проверка и запись topic_prereqs.jsonl.
5) Расширить sync_from_jsonl для Subsection и выполнить импорт (после вашего подтверждения).
6) Запустить тесты и показать сводку/метрики.

Готов перейти к реализации после подтверждения.