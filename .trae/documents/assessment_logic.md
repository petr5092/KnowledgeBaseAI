# Полная документация модуля Assessment Service

## 1. Введение
Модуль **AssessmentService** предназначен для проведения входного тестирования знаний пользователей. Он реализует полный цикл: от генерации персонализированных вопросов с помощью LLM до автоматической проверки ответов, сохранения детального профиля обучения и обновления уровня мастерства навыков.

Этот документ содержит исчерпывающее описание всех структур данных, сущностей базы данных и алгоритмов, задействованных в работе модуля.

---

## 2. Схема Базы Данных (PostgreSQL)

В основе модуля лежит таблица `assessment_results`, которая хранит агрегированные итоги тестирования. Она связана с пользователем, его целью обучения и психотипом. Кроме того, результаты влияют на таблицу `skill_mastery`, которая служит "долгосрочной памятью" системы о навыках пользователя.

### 2.1. Сущность `AssessmentResult`
**Таблица**: `assessment_results`
**Файл модели**: `app/core/postgres/models/assessment.py`

Хранит финальный отчет о прохождении входного тестирования.

| Поле | Тип (SQL) | Описание |
| :--- | :--- | :--- |
| `id` | UUID (PK) | Уникальный идентификатор результата. |
| `user_id` | UUID (FK) | Ссылка на пользователя (`users.id`). |
| `user_goal_id` | UUID (FK) | Ссылка на цель обучения (`user_goals.id`). |
| `test_id` | String | ID теста из Redis (для истории/отладки). |
| `attempt_id` | UUID (FK, Nullable) | Ссылка на попытку (`assessment_attempts.id`). В текущей версии `AssessmentService` **не используется** (остается NULL), зарезервировано для интеграции с KB. |
| `total_score` | Integer | Набранный балл. |
| `max_score` | Integer | Максимально возможный балл. |
| `percentage` | Float | Процент выполнения (0-100). |
| `overall_level` | String | Общий уровень знаний (beginner / intermediate / advanced). |
| `personalized_summary` | Text | Текстовое резюме от ИИ для пользователя. |
| `next_steps` | JSON Array | Список рекомендуемых следующих шагов (строки). |
| `questions_results` | JSON Array | Детальный отчет по каждому вопросу (см. структуру ниже). |
| `level_assessments` | JSON Array | Оценка уровня по темам (см. структуру ниже). |
| `topic_mastery_levels` | JSON Object | Словарь `{ "topic_name": mastery_level_int }`. |
| `weak_concepts` | JSON Array | Список концепций, требующих проработки. |
| `strong_concepts` | JSON Array | Список уверенно освоенных концепций. |
| `learning_style_indicators`| JSON Object | Индикаторы стиля обучения (визуальный, аналитический и т.д.). |
| `created_at` | DateTime | Дата и время прохождения теста. |

#### Структура JSON-полей в `AssessmentResult`

**`questions_results` (Массив объектов):**
```json
[
  {
    "question_id": "q1",
    "is_correct": false,
    "score": 0,
    "max_score": 1,
    "user_answer": "5",
    "correct_answer": "6",
    "topic": "Планиметрия",
    "explanation": "Площадь треугольника равна...",
    "personalized_feedback": "Ты забыл разделить на 2...",
    "solution_steps_analysis": "В шаге 2 ошибка вычисления...",
    "time_spent": 45.5
  }
]
```

**`level_assessments` (Массив объектов):**
```json
[
  {
    "subject": "Математика",
    "topic": "Тригонометрия",
    "level": "beginner",
    "confidence": 0.85,
    "strengths": ["Знание табличных значений"],
    "weaknesses": ["Формулы приведения"],
    "recommendations": ["Повторить свойства периодичности"]
  }
]
```

### 2.2. Связанные сущности

#### `UserGoal` (Цель пользователя)
**Таблица**: `user_goals`
**Файл модели**: `app/core/postgres/models/goal.py`
Контекст, в рамках которого проходит тестирование.
*   `subject`: Предмет (например, "Математика").
*   `exam_type`: Тип экзамена (ЕГЭ Профиль, ЕГЭ База, ОГЭ).
*   `current_grade` / `target_grade`: Оценки для калибровки сложности теста.

#### `Psychotype` (Психотип)
**Таблица**: `psychotypes`
**Файл модели**: `app/core/postgres/models/psychotype.py`
Используется для адаптации стиля вопросов и обратной связи.
*   `hbdi_code`: Код профиля мышления (например, "1234").
*   `label`: Название типа (например, "Аналитик").

#### `SkillMastery` (Мастерство навыков)
**Таблица**: `skill_mastery`
**Файл модели**: `app/kb_integration/models.py`
Хранит текущий динамический вес (уровень владения) навыками пользователя. Обновляется после каждого теста и используется для персонализации дорожной карты.
*   `user_id`: ID пользователя.
*   `kb_skill_uid`: UID навыка в базе знаний (Knowledge Base).
*   `mastery_level`: Уровень владения (0-100).
*   `total_attempts` / `correct_attempts`: Статистика успешности.

#### `AssessmentAttempt` (Попытка тестирования - KB Integration)
**Таблица**: `assessment_attempts`
**Файл модели**: `app/kb_integration/models.py`
**Важно**: Эта таблица существует в БД и связана с `AssessmentResult` через FK `attempt_id`. Однако, текущая реализация `AssessmentService` (генерация "на лету" через LLM) **не создает** записи в этой таблице. Она предназначена для более сложной системы тестирования на базе Knowledge Base (KB), где тесты (`AssessmentTest`) хранятся персистентно.

---

## 3. Структуры Данных (Pydantic DTOs)

Все DTO определены в `app/schemas/assessment_dto.py`.

### 3.1. Запросы (Requests)

#### `InitialTestRequest`
Данные для генерации теста.
*   `user_goal_id` (UUID): ID цели.
*   `questions_count` (int): Желаемое количество вопросов (обычно 10-15).
*   `topics_focus` (list[str]): Список тем для акцентирования (опционально).
*   `known_exam_tasks` (list[int]): Номера заданий ЕГЭ (1-19), которые пользователь уже изучил. Используется для фильтрации вопросов.

#### `TestSubmissionRequest`
Отправка ответов на проверку.
*   `test_id` (str): ID теста (ключ Redis).
*   `answers` (list[`UserAnswer`]):
    *   `question_id` (str): ID вопроса.
    *   `answer` (str): Ответ пользователя.
    *   `solution_steps` (list[`SolutionStep`]): Шаги решения (номер, описание).

### 3.2. Ответы (Responses)

#### `InitialTestResponse`
Возвращается фронтенду после генерации.
*   `test` (`InitialTest`): Объект теста (см. ниже), **без** правильных ответов.
*   `personalized_message` (str): Приветствие.

#### `TestResult`
Полный результат проверки.
*   Содержит все поля, аналогичные таблице `AssessmentResult`, плюс детальные объекты `QuestionResult`.

### 3.3. Внутренние структуры

#### `Question` (Вопрос)
Основная единица теста.
*   `id`: Уникальный ID внутри теста (q1, q2...).
*   `question_text`: Текст условия.
*   `question_type`: Enum (`numeric`, `single_choice`, `text_input`).
*   `topic`: Тема вопроса.
*   `correct_answer`: Правильный ответ (скрыт от клиента в `InitialTestResponse`).
*   `verification_expr`: Выражение SymPy для точной проверки (опционально).

#### `InitialTest` (Объект теста)
Контейнер для вопросов.
*   `test_id`: UUID (строка).
*   `user_goal_id`: UUID.
*   `questions`: Список объектов `Question`.

---

## 4. Redis Хранилище

Redis используется как временное хранилище состояния теста ("state store") между этапами генерации и проверки. Это позволяет не хранить сгенерированные вопросы в БД до момента получения результатов.

*   **Ключ**: `test:{test_id}` (где `test_id` — UUIDv4).
*   **Значение**: JSON-сериализованный объект `InitialTest`.
*   **TTL**: 3600 секунд (1 час). Если пользователь не отправит ответы за это время, тест "сгорает".

**Пример JSON в Redis:**
```json
{
  "test_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_goal_id": "...",
  "questions": [
    {
      "id": "q1",
      "question_text": "Решите уравнение...",
      "correct_answer": "5",
      "points": 1,
      ...
    }
  ]
}
```

---

## 5. Алгоритмы и Логика Работы

### 5.1. Алгоритм Генерации (`generate_initial_test`)
1.  **Сбор контекста**: Извлекаются данные `UserGoal` и `Psychotype`.
2.  **Фильтрация тем**: Если переданы `known_exam_tasks`, сервис маппит их на темы (через словарь `ege_math_profile_topics_mapping` в коде).
3.  **Prompt Engineering**:
    *   Выбирается шаблон промпта в зависимости от типа цели (Exam, Skill, Topic).
    *   В промпт вставляются жесткие инструкции по формату JSON и педагогические требования (например, "избегать банальных задач").
    *   Добавляются специфические правила для определенных номеров заданий (например, для задачи №6 на тарифы — требование разных периодов действия).
4.  **Генерация и Валидация**:
    *   LLM возвращает JSON.
    *   `QuestionValidator` проверяет типы полей.
    *   `QuestionRepairer` пытается исправить числовые форматы (замена запятых на точки и т.д.).
5.  **Кэширование**: Тест сохраняется в Redis.

### 5.2. Алгоритм Оценивания (`submit_test`)
1.  **Принцип "Одна попытка" (Single Attempt)**: В системе строго соблюдается правило: пользователю не дается вторых попыток на один и тот же вопрос. Ответ считается окончательным.
2.  **Восстановление контекста**: По `test_id` из Redis загружается исходный тест. Каждый вопрос в тесте ("stateless" объект из KB) уже содержит метаданные о связанных темах и навыках.
3.  **LLM-Грейдинг и Расчет Весов**:
    *   Модель оценивает ответы.
    *   На основе правильности ответов и метаданных вопроса (сложность, связь с темами) вычисляется **динамический вес пользователя** по затронутым темам.
4.  **Нормализация**:
    *   Сервис пересчитывает `total_score`.
5.  **Обновление Мастерства (SkillMastery)**:
    *   Динамически высчитанные веса (уровни владения) сохраняются в таблицу `skill_mastery`.
6.  **Персистентность**: Результат сохраняется в PostgreSQL.

### 5.3. Интеграция с Генерацией Дорожной Карты (`generate_roadmap`)
Этот этап замыкает цикл "Тестирование -> Персонализация".

1.  **Агрегация Весов**: По окончанию тестирования система собирает все динамически высчитанные веса пользователя по темам из `SkillMastery`.
2.  **Передача в KB**: Эти веса передаются в эндпоинт генерации дорожной карты (см. логику в `app/kb_integration/router.py`).
3.  **Генерация Плана**: Stateless база знаний использует переданные веса для построения графа обучения. Темы, в которых пользователь набрал высокий вес, помечаются как освоенные или пропускаются; слабые темы становятся приоритетными узлами в дорожной карте.
4.  **Результат**: Пользователь получает полностью персонализированный путь обучения (`StudyPlan`).

---

## 6. Интеграция с другими сервисами

*   **RAG (Optional)**: Если настроен `RAGService`, сгенерированные вопросы асинхронно индексируются в Qdrant для пополнения базы знаний.
*   **Billing**: `AssessmentService` проверяет права доступа к функционалу (косвенно, через Dependency Injection и политики доступа, если они есть).
*   **Study Plan**: Результаты из `AssessmentResult` и `SkillMastery` используются для генерации дорожной карты обучения.
