<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Curriculum Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg: #0b0c10; --card: #121317; --text: #e6e6e6; --muted: #9aa0a6; --accent: #4ade80; --danger: #ef4444; --border: #1f2228; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; background: var(--bg); color: var(--text); }
    header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
    header h1 { font-size: 18px; margin: 0; letter-spacing: .2px; }
    .container { padding: 20px; max-width: 1100px; margin: 0 auto; }
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab { padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); cursor: pointer; }
    .tab.active { outline: 2px solid var(--accent); }
    .grid { display: grid; gap: 16px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 12px; font-size: 16px; }
    label { display: block; font-size: 12px; color: var(--muted); margin: 12px 0 6px; }
    input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: #0c0d12; color: var(--text); }
    textarea { resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; background: var(--accent); color: #051b0f; font-weight: 600; }
    .btn.secondary { background: #2c2f36; color: var(--text); }
    .btn.danger { background: var(--danger); color: #fff; }
    .flex { display: flex; gap: 10px; }
    .toolbar { display: flex; gap: 8px; align-items: center; justify-content: flex-end; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid var(--border); padding: 10px; font-size: 13px; }
    .table th { text-align: left; color: var(--muted); font-weight: 600; }
    .chip { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #1c2126; color: var(--text); font-size: 12px; }
    .toast { position: fixed; right: 16px; bottom: 16px; background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 12px 14px; border-radius: 10px; display: none; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <h1>Curriculum Admin</h1>
    <div class="toolbar">
      <input id="apiKey" placeholder="X-API-Key" style="width:280px" />
      <button class="btn secondary" onclick="copyCurl()">cURL</button>
    </div>
  </header>
  <div class="container">
    <div class="tabs">
      <div class="tab active" id="tab-create" onclick="setTab('create')">Создание</div>
      <div class="tab" id="tab-nodes" onclick="setTab('nodes')">Узлы</div>
      <div class="tab" id="tab-view" onclick="setTab('view')">Просмотр</div>
    </div>

    <div id="panel-create" class="grid grid-2">
      <div class="card">
        <h2>Создать Curriculum</h2>
        <label>code</label>
        <input id="curCode" placeholder="RU_FGOS_2021_MATH" />
        <label>title</label>
        <input id="curTitle" placeholder="ФГОС Математика" />
        <label>standard</label>
        <input id="curStd" placeholder="FGOS" />
        <label>language</label>
        <input id="curLang" value="ru" />
        <div class="flex">
          <button class="btn" onclick="createCurriculum()">Создать</button>
          <button class="btn secondary" onclick="resetCreate()">Сбросить</button>
        </div>
      </div>
      <div class="card">
        <h2>Результат</h2>
        <pre id="curCreateOut"></pre>
      </div>
    </div>

    <div id="panel-nodes" class="grid grid-2 hidden">
      <div class="card">
        <h2>Добавить узлы</h2>
        <label>code</label>
        <input id="nodesCode" placeholder="RU_FGOS_2021_MATH" />
        <div class="card" style="margin-top:12px">
          <div class="row">
            <div>
              <label>kind</label>
              <select id="rowKind"><option value="TOPIC">TOPIC</option><option value="SKILL">SKILL</option></select>
            </div>
            <div>
              <label>canonical_uid</label>
              <input id="rowUid" placeholder="TOP-LIN-EQ" />
            </div>
            <div>
              <label>order_index</label>
              <input id="rowOrder" type="number" value="1" />
            </div>
            <div>
              <label>is_required</label>
              <select id="rowReq"><option value="true">true</option><option value="false">false</option></select>
            </div>
          </div>
          <div class="flex" style="margin-top:12px">
            <button class="btn" onclick="addRow()">Добавить строку</button>
            <button class="btn danger" onclick="clearRows()">Очистить</button>
          </div>
        </div>
        <label>nodes (JSONL)</label>
        <textarea id="nodesJson" rows="10"></textarea>
        <div class="flex">
          <button class="btn" onclick="addNodes()">Отправить</button>
          <button class="btn secondary" onclick="downloadNodes()">Скачать .jsonl</button>
        </div>
      </div>
      <div class="card">
        <h2>Проверка</h2>
        <pre id="nodesOut"></pre>
      </div>
    </div>

    <div id="panel-view" class="grid grid-2 hidden">
      <div class="card">
        <h2>Просмотр</h2>
        <label>code</label>
        <input id="viewCode" placeholder="RU_FGOS_2021_MATH" />
        <div class="flex" style="margin-top:12px">
          <button class="btn" onclick="viewCurriculum()">Получить</button>
          <select id="filterKind"><option value="">Все</option><option value="TOPIC">TOPIC</option><option value="SKILL">SKILL</option></select>
        </div>
      </div>
      <div class="card">
        <h2>Узлы</h2>
        <table class="table" id="nodesTable"><thead><tr><th>kind</th><th>canonical_uid</th><th>order_index</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    function setTab(tab) {
      for (const id of ['create','nodes','view']) {
        document.getElementById('panel-' + id).classList.add('hidden')
        document.getElementById('tab-' + id).classList.remove('active')
      }
      document.getElementById('panel-' + tab).classList.remove('hidden')
      document.getElementById('tab-' + tab).classList.add('active')
    }
    function showToast(text) {
      const t = document.getElementById('toast')
      t.textContent = text
      t.style.display = 'block'
      setTimeout(() => { t.style.display = 'none' }, 2000)
    }
    async function createCurriculum() {
      const code = document.getElementById('curCode').value.trim()
      const title = document.getElementById('curTitle').value.trim()
      const standard = document.getElementById('curStd').value.trim()
      const language = document.getElementById('curLang').value.trim()
      const key = document.getElementById('apiKey').value.trim()
      const r = await fetch('/api/admin/curriculum', { method: 'POST', headers: {'Content-Type':'application/json','X-API-Key': key}, body: JSON.stringify({code, title, standard, language}) })
      document.getElementById('curCreateOut').textContent = await r.text()
      showToast('Создано')
    }
    function resetCreate() {
      document.getElementById('curCode').value = ''
      document.getElementById('curTitle').value = ''
      document.getElementById('curStd').value = ''
      document.getElementById('curLang').value = 'ru'
    }
    function addRow() {
      const kind = document.getElementById('rowKind').value
      const uid = document.getElementById('rowUid').value.trim()
      const order = parseInt(document.getElementById('rowOrder').value || '1', 10)
      const req = document.getElementById('rowReq').value === 'true'
      const obj = { kind, canonical_uid: uid, order_index: order, is_required: req }
      const txt = document.getElementById('nodesJson')
      txt.value = (txt.value ? txt.value + '\n' : '') + JSON.stringify(obj)
    }
    function clearRows() { document.getElementById('nodesJson').value = '' }
    async function addNodes() {
      const code = document.getElementById('nodesCode').value.trim()
      const key = document.getElementById('apiKey').value.trim()
      const txt = document.getElementById('nodesJson').value
      const nodes = []
      for (const line of txt.split('\n')) {
        const s = line.trim()
        if (!s) continue
        try { nodes.push(JSON.parse(s)) } catch {}
      }
      const r = await fetch('/api/admin/curriculum/nodes', { method: 'POST', headers: {'Content-Type':'application/json','X-API-Key': key}, body: JSON.stringify({code, nodes}) })
      document.getElementById('nodesOut').textContent = await r.text()
      showToast('Узлы добавлены')
    }
    function downloadNodes() {
      const txt = document.getElementById('nodesJson').value
      const blob = new Blob([txt], {type: 'text/plain'})
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = 'curriculum_nodes.jsonl'
      a.click()
    }
    async function viewCurriculum() {
      const code = document.getElementById('viewCode').value.trim()
      const r = await fetch('/api/curriculum/graph_view?code=' + encodeURIComponent(code))
      const data = await r.json()
      const tbody = document.querySelector('#nodesTable tbody')
      tbody.innerHTML = ''
      const filter = document.getElementById('filterKind').value
      for (const it of (data.nodes || [])) {
        if (filter && it.kind !== filter) continue
        const tr = document.createElement('tr')
        const td1 = document.createElement('td')
        const td2 = document.createElement('td')
        const td3 = document.createElement('td')
        td1.textContent = it.kind
        td2.textContent = it.canonical_uid
        td3.textContent = it.order_index
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3)
        tbody.appendChild(tr)
      }
      showToast('Загружено')
    }
    function copyCurl() {
      const code = document.getElementById('curCode').value.trim() || 'RU_FGOS_2021_MATH'
      const title = document.getElementById('curTitle').value.trim() || 'ФГОС Математика'
      const standard = document.getElementById('curStd').value.trim() || 'FGOS'
      const language = document.getElementById('curLang').value.trim() || 'ru'
      const key = document.getElementById('apiKey').value.trim() || 'kb-admin-key'
      const cmd = `curl -X POST http://localhost:5000/api/admin/curriculum -H "Content-Type: application/json" -H "X-API-Key: ${key}" -d '{"code":"${code}","title":"${title}","standard":"${standard}","language":"${language}"}'`
      navigator.clipboard.writeText(cmd)
      showToast('cURL скопирован')
    }
  </script>
</body>
</html>
