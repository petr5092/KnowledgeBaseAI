<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Конструктор и визуализатор знаний</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://unpkg.com/axios@1.7.7/dist/axios.min.js"></script>
    <script src="https://unpkg.com/cytoscape@3.28.0/dist/cytoscape.min.js"></script>
  </head>
  <body>
    <header class="app-header" style="display:flex; align-items:center; justify-content:space-between;">
      <h1>Конструктор и визуализатор знаний</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <label>Предмет</label>
        <select id="subjectFilter">
          <option value="">Все</option>
          {% for s in subjects %}
            <option value="{{ s.uid }}">{{ s.title }}</option>
          {% endfor %}
        </select>
        <button id="refreshGraph">Обновить граф</button>
        <button id="fitGraphBtn" title="Автоматически вместить граф в область">Вместить</button>
        <button id="zoomInBtn" title="Увеличить">+</button>
        <button id="zoomOutBtn" title="Уменьшить">−</button>
        <button id="loadNeighborhoodBtn" title="Загрузить окрестность выбранного узла">Окрестность</button>
      </div>
    </header>

    <main class="layout">
      <section class="left-panel">
        <div class="panel-block">
          <h2>Визуализатор</h2>
          <span class="hint">Клик по узлу показывает детали справа. Используйте фильтры и поиск, чтобы сфокусироваться.</span>
          <div class="controls" style="display:grid; grid-template-columns:1fr; gap:8px;">
            <div>
              <label>Поиск по названию</label>
              <div style="display:flex; gap:6px;">
                <input id="searchBox" placeholder="Введите часть названия">
                <button id="searchBtn">Найти</button>
              </div>
              <span class="hint">Подсветка найденных узлов и вывод их метаданных возможен по клику.</span>
            </div>
            <div>
              <label>Порог степени узла</label>
              <input id="degreeSlider" type="range" min="0" max="6" value="0">
              <span id="degreeValue">0</span>
              <span class="hint">Скрывает узлы с меньшим количеством связей, помогает убрать шум.</span>
            </div>
            <div>
          <label>Фильтр типов</label>
          <div class="type-filters" style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
            <label><input type="checkbox" id="cbSubject" checked> subject</label>
            <label><input type="checkbox" id="cbSection" checked> section</label>
            <label><input type="checkbox" id="cbTopic" checked> topic</label>
            <label><input type="checkbox" id="cbSkill" checked> skill</label>
            <label><input type="checkbox" id="cbMethod" checked> method</label>
            <label><input type="checkbox" id="cbGoal" checked> goal</label>
            <label><input type="checkbox" id="cbObjective" checked> objective</label>
          </div>
          <span class="hint">Отключите лишние типы, чтобы упростить картину.</span>
          <div style="margin-top:8px;">
            <label>Связи</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
              <label><input type="checkbox" id="relContains" checked> contains</label>
              <label><input type="checkbox" id="relHasSkill" checked> has_skill</label>
              <label><input type="checkbox" id="relPrereq" checked> PREREQ</label>
              <label><input type="checkbox" id="relTargets" checked> targets</label>
              <label><input type="checkbox" id="relLinked" checked> linked</label>
            </div>
            <span class="hint">Переключайте типы связей для сфокусированного анализа.</span>
          </div>
        </div>
            <div>
              <label>Раскладка</label>
              <div style="display:flex; gap:6px;">
                <select id="layoutSelect">
                  <option value="cose">cose</option>
                  <option value="concentric">concentric</option>
                  <option value="grid">grid</option>
                  <option value="circle">circle</option>
                </select>
                <button id="rerunLayoutBtn">Применить</button>
              </div>
              <span class="hint">Смените алгоритм раскладки для разных типов графов.</span>
            </div>
          </div>
        </div>

        <div class="panel-block">
          <h2>Добавить предмет</h2>
          <input id="subjTitle" placeholder="Название">
          <input id="subjDesc" placeholder="Описание">
          <button id="addSubjectBtn">Создать</button>
        </div>

        <div class="panel-block">
          <h2>Добавить раздел</h2>
          <label>Предмет</label>
          <select id="sectionSubject">
            {% for s in subjects %}
              <option value="{{ s.uid }}">{{ s.title }}</option>
            {% endfor %}
          </select>
          <input id="sectionTitle" placeholder="Название">
          <input id="sectionDesc" placeholder="Описание">
          <button id="addSectionBtn">Создать</button>
        </div>

        <div class="panel-block">
          <h2>Добавить тему</h2>
          <label>Раздел</label>
          <select id="topicSection"></select>
          <input id="topicTitle" placeholder="Название">
          <input id="topicDesc" placeholder="Описание">
          <button id="addTopicBtn">Создать</button>
        </div>

        <div class="panel-block">
          <h2>Добавить цель темы</h2>
          <label>Тема</label>
          <select id="goalTopic"></select>
          <input id="goalTitle" placeholder="Формулировка цели">
          <button id="addTopicGoalBtn">Создать</button>
        </div>

        <div class="panel-block">
          <h2>Добавить задачу темы</h2>
          <label>Тема</label>
          <select id="objTopic"></select>
          <input id="objTitle" placeholder="Формулировка задачи">
          <button id="addTopicObjectiveBtn">Создать</button>
        </div>

        <div class="panel-block">
          <h2>Добавить навык</h2>
          <label>Предмет</label>
          <select id="skillSubject">
            {% for s in subjects %}
              <option value="{{ s.uid }}">{{ s.title }}</option>
            {% endfor %}
          </select>
          <input id="skillTitle" placeholder="Название">
          <input id="skillDef" placeholder="Определение">
          <button id="addSkillBtn">Создать</button>
        </div>

        <div class="panel-block">
          <h2>Добавить метод</h2>
          <input id="methodTitle" placeholder="Название">
          <textarea id="methodText" placeholder="Описание метода"></textarea>
          <input id="methodTypes" placeholder="Типы применимости (через запятую)">
          <button id="addMethodBtn">Создать</button>
        </div>

        <div class="panel-block">
          <h2>Связать навык ↔ метод</h2>
          <label>Навык</label>
          <select id="linkSkill"></select>
          <label>Метод</label>
          <select id="linkMethod"></select>
          <select id="linkWeight">
            <option value="primary">primary</option>
            <option value="secondary">secondary</option>
            <option value="auxiliary">auxiliary</option>
          </select>
          <input id="linkConf" type="number" step="0.01" value="0.9">
          <button id="linkBtn">Создать связь</button>
        </div>
      </section>

      <section class="right-panel">
        <div id="graph" class="graph"></div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button id="syncNeo4jBtn">Синхронизировать в Neo4j</button>
          <button id="normalizeKbBtn">Нормализовать KB</button>
          <button id="analyzeBtn">Аналитика</button>
          <button id="exportJsonBtn">Экспорт JSON</button>
        </div>
        <div style="margin-top:8px;">
          <span class="badge subject">Subject</span>
          <span class="badge section">Section</span>
          <span class="badge topic">Topic</span>
          <span class="badge skill">Skill</span>
          <span class="badge method">Method</span>
          <span class="badge goal">Goal</span>
          <span class="badge objective">Objective</span>
        </div>
        <div id="drawer" style="margin-top:12px; padding:12px; border:1px solid #1f2328; border-radius:8px; background:#0f1318;">
          <h3 style="margin:0 0 8px;">Детали узла</h3>
          <pre id="analysisOut" style="max-height:220px; overflow:auto;"></pre>
        </div>
      </section>
    </main>

    <script src="/static/js/knowledge.js"></script>
  </body>
</html>
