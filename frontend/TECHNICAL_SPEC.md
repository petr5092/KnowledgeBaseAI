# Техническое задание (ТЗ) на разработку Frontend приложения KnowledgeBaseAI

## 1. Введение и Текущий статус
Приложение **KnowledgeBaseAI** — это инструмент для работы с семантическими графами, включающий визуализацию, редактирование и AI-ассистента.

**Текущее состояние проекта:**
*   Развернута базовая архитектура на Vite + React 19 + TypeScript.
*   Реализован базовый роутинг и лейаут.
*   **ExplorePage**: Реализована визуализация на `vis-network` с физикой, но отсутствует глубокая интеграция с данными узлов.
*   **EditPage**: Реализован прототип редактора на `reactflow` с локальным стейтом и CRUD, но без сохранения на бэкенд.
*   **AI Assistant**: Реализован чат-виджет с базовыми запросами, но без стриминга ответов и сложной обработки действий.

## 2. Стек технологий
*   **Core**: React 19, TypeScript 5.
*   **Build**: Vite 7.
*   **Routing**: React Router v7.
*   **State Management**: React Context / Hooks + `TxLog` (Observer pattern).
*   **Visualization**:
    *   `vis-network` (Explore mode).
    *   `reactflow` (Edit mode).
    *   `d3` (Utils & Charts).
*   **Styling**: Native CSS Variables (Theming).

## 3. Декомпозиция задач (Detailed Backlog)

### Эпик 1: Архитектура и Инфраструктура (Core)
Цель: Обеспечить стабильную основу для масштабирования приложения и обработки ошибок.

*   **[CORE-01] Глобальная обработка ошибок и уведомления**
    *   *Задача*: Создать систему `Toast` уведомлений, интегрированную с `apiFetch` и `TxLog`.
    *   *Требования*:
        *   Перехват всех `HttpError`.
        *   Отображение всплывающих уведомлений (Success/Error/Info).
        *   Автоматическое скрытие через 5 сек.
*   **[CORE-02] Улучшение типизации API**
    *   *Задача*: Расширить `api.ts` строгими схемами (Zod опционально) для ответов бэкенда.
    *   *Sub-tasks*:
        *   Типизировать `ViewportResponse` (проверить наличие полей `color`, `shape`).
        *   Типизировать `AssistantAction` payloads.

### Эпик 2: Модуль "Explore" (Просмотр графа)
Цель: Превратить `ExplorePage.tsx` из прототипа в полноценный инструмент анализа.

*   **[EXP-01] Оптимизация рендеринга vis-network**
    *   *Проблема*: При переключении вкладок граф пересоздается.
    *   *Задача*: Вынести инстанс `Network` в `useRef` или Context, сохранять позицию камеры (viewport) при навигации.
*   **[EXP-02] Расширенная карточка узла**
    *   *Задача*: При клике на узел (событие `selectNode`) открывать детальную панель (Sidebar/Drawer) справа.
    *   *Контент*:
        *   Метаданные узла (UID, Title, Kind).
        *   Список входящих/исходящих связей.
        *   Кнопка "Спросить AI об этом узле".
*   **[EXP-03] Фильтрация и Легенда**
    *   *Задача*: Добавить UI для фильтрации узлов по `kind` (типу).
    *   *UI*: Панель с чекбоксами для каждого типа узла, присутствующего в Viewport.

### Эпик 3: Модуль "Edit" (Редактор графа)
Цель: Реализовать полноценный CRUD с сохранением данных на сервере.

*   **[EDT-01] Синхронизация с Бэкендом**
    *   *Задача*: Заменить локальный `useState` и `localStorage` на API вызовы.
    *   *API*:
        *   `POST /v1/graph/node` (создание).
        *   `PATCH /v1/graph/node/{uid}` (обновление).
        *   `DELETE /v1/graph/node/{uid}` (удаление).
        *   Аналогично для ребер (`edge`).
*   **[EDT-02] Панель свойств (Property Inspector)**
    *   *Задача*: Улучшить UX панели свойств (сейчас это просто инпуты).
    *   *Требования*:
        *   Валидация UID (запрет пробелов, спецсимволов).
        *   Выпадающий список для выбора `Type` (узла/ребра).
*   **[EDT-03] Инструменты Layout**
    *   *Задача*: Добавить кнопку "Auto Layout" (Dagre или Elkjs) для автоматического упорядочивания графа в редакторе.

### Эпик 4: AI Ассистент (Assistant)
Цель: Сделать ассистента контекстно-зависимым и интерактивным.

*   **[AI-01] Markdown и Стриминг**
    *   *Задача*: Поддержка Markdown разметки в сообщениях ассистента (жирный текст, списки, код).
    *   *Реализация*: Использовать `react-markdown`.
*   **[AI-02] Интерактивные действия в чате**
    *   *Задача*: Если ассистент возвращает список узлов (например, "Вот связанные темы"), рендерить их как интерактивные кнопки/чипсы.
    *   *Действие*: При клике на чипс -> переход к узлу в `ExplorePage`.
*   **[AI-03] История чата**
    *   *Задача*: Сохранять историю сообщений в `sessionStorage` или `localStorage`, чтобы она не пропадала при перезагрузке страницы.

### Эпик 5: Аналитика и Дорожные карты
Цель: Реализовать заглушки страниц данными.

*   **[ANL-01] Визуализация метрик**
    *   *Задача*: В `AnalyticsPage.tsx` реализовать графики на `d3` или `recharts`.
    *   *Метрики*: Распределение узлов по типам, динамика добавления узлов.
*   **[RDM-01] Рендеринг Roadmap**
    *   *Задача*: В `RoadmapPage.tsx` отображать граф зависимостей (Tree layout) для учебного плана.
    *   *Логика*: Узлы — темы, связи — зависимости "требует изучения".

## 4. Технические стандарты и API Contracts

### 4.1 Формат ошибок (HttpError)
```typescript
{
  status: number;  // HTTP Code
  message: string; // Human readable message
  details?: any;   // Validation errors or stack trace
}
```

### 4.2 Модель данных графа (Frontend)
```typescript
interface GraphNode {
  uid: string;
  title?: string;
  kind: 'concept' | 'skill' | 'resource';
  data?: Record<string, any>;
}

interface GraphEdge {
  source: string;
  target: string;
  relation: string;
  weight?: number;
}
```

## 5. Критерии приемки (Definition of Done)

1.  **Код**:
    *   Отсутствие `any` (кроме исключительных случаев в API).
    *   Все компоненты имеют типизированные `Props`.
    *   Нет ошибок в консоли браузера при навигации.
2.  **UX**:
    *   Индикация загрузки (`isLoading`) на всех асинхронных кнопках/панелях.
    *   Обработка пустых состояний (Empty States) для списков и графов.
3.  **Тестирование**:
    *   (Опционально) Unit-тесты для утилит (`inversePatch`, `d3` helpers).
