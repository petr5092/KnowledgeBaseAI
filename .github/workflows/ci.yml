name: CI

on:
  push:
    branches: [ latest, main, master ]
  pull_request:
    branches: [ latest, main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Start services
        run: |
          docker compose --env-file .env.prod up -d
      - name: Healthcheck services
        run: |
          for i in {1..30}; do
            if docker compose --env-file .env.prod exec -T fastapi python - <<'PY'
import socket, sys
def check(host, port):
  s = socket.socket()
  s.settimeout(2)
  try:
    s.connect((host, port))
    s.close()
    return True
  except Exception:
    return False
ok = all([
  check("neo4j", 7687),
  check("redis", 6379),
  check("postgres", 5432),
])
sys.exit(0 if ok else 1)
PY
            then
              echo "Services healthy"
              break
            else
              echo "Waiting for services..."
              sleep 5
            fi
          done
          docker compose --env-file .env.prod ps
      - name: Run unit tests
        run: |
          docker compose --env-file .env.prod exec -T fastapi pytest -q
