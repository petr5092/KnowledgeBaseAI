# База знаний StudyNinja — концепция и спецификация

## Введение
- Назначение: единый источник истины (Single Source of Truth) о предметной области, обеспечивающий детерминированные решения системы в диагностике, адаптации и обучении.
- Ключевой принцип: причинно-следственная связность между знаниями, действиями системы и результатами обучения.
- Область применения: адресация контента (предмет → раздел → тема), планирование и дорожные карты (граф навыков), выбор следующего шага, объяснение, корректирующая обратная связь.

## Нотация
- `σ(тема)` — минимальное замкнутое по предпосылкам множество целевых навыков темы.
- `S(тема)` — канонический класс заданий темы с едиными критериями оценивания.
- Освоение темы — устойчивое применение `σ(тема)` к `S(тема)` с выполнением порогов платформы.

## Политика идентификаторов (UID)
- Устойчивые UID для всех сущностей в OLTP (`PostgreSQL`), глобально уникальны в пределах платформы.
- Формат (пример): `SUB-<ULID>` (предмет), `SEC-<ULID>` (раздел), `TOP-<ULID>` (тема), `SKL-<ULID>` (навык), `MTH-<ULID>` (метод), `EXM-<ULID>` (пример), `ERR-<ULID>` (ошибка).
- Требования: неизменяемость, человеко-читаемые префиксы, отсутствие утечек смысла в ULID/UUID части.
- Генерация: на уровне сервисов, транзакционно; запрет переиспользования удалённых UID; аудит создания.

## Сущности

### Предмет / Раздел / Тема
- Иерархия адресации: жёсткие связи один-ко-многим (`предмет → раздел → тема`).
- Уникальности: тема принадлежит ровно одному разделу; раздел ровно одному предмету.
- Атрибуты: `title`, `description`, метаданные (язык, программа), порог освоения темы, банк примеров темы.

### Навык
- Атомарная измеряемая единица мастерства; вершина предметного графа вне иерархии адресации.
- Связи: `тема ↔ навык` (M:N), `навык ↔ метод` (M:N), `пример ↔ навык` (M:N), `ошибка ↔ навык` (M:N).
- Атрибуты: `title`, `definition`, `type`, `status` (активен/архив), `prerequisite` (ребра DAG внутри предмета).

### Метод
- Формализованный способ выполнения действия над навыком; стратегия объяснения и генератор шагов.
- Применимость: только к валидным типам навыков; проверяется внешними ключами и типами метода в OLTP.
- Атрибуты: `title`, `method_text`, `applicability_types`, ссылки на примеры и типовые ошибки.

### Пример
- Минимальная исполняемая учебно-контрольная единица; проверяет один или несколько навыков.
- Контекст предъявления: ровно один предмет и одна тема.
- Роли на ребре `пример ↔ навык`: `целевой`, `вспомогательный`, `контекстный` — влияют на диагностику и оценивание.
- Сложность: шкала 1–5 (см. раздел «Порог освоения и сложность»).
- Атрибуты: `title`, `statement`, `difficulty`, ссылки на методы, мультимедиа.

### Ошибка
- Типовой паттерн ошибки; всегда связана как минимум с одним навыком, опционально с примером.
- Может ссылаться на метод как на неверную стратегию, не нарушая обязательной привязки к навыку.
- Атрибуты: `title`, `error_text`, `triggers`, `boosters`/интервенции.

## Связи и инварианты
- `Предмет → Раздел → Тема`: строгая иерархия адресации; без перекрёстной принадлежности.
- `Тема ↔ Навык` (M:N): тема опирается на множество навыков; один навык используется в нескольких темах одного предмета.
- `Навык ↔ Метод` (M:N): применимость проверяется типами; недопустимы связи вне объявленной валидности.
- `Пример ↔ Навык` (M:N): роли на ребре обязательны; полный список целевых и вспомогательных навыков.
- `Ошибка ↔ Навык` (M:N), `Ошибка ↔ Пример` (M:N, опционально): активируют бустеры.
- `Prerequisite` (DAG внутри предмета): ориентированный ациклический граф; циклы запрещены, ребро создаётся только при прохождении валидации.

## Диагностика (OLTP-модель)
- События попытки: `Attempt` (ученик, пример, время, источник), `Step`/`Action` (шаги решения, если применимо).
- Результаты: `Evaluation` по навыкам с учётом ролей (целевые влияют сильнее, вспомогательные — умеренно, контекстные — слабо).
- Ошибки: `ErrorEvent` с привязкой к навыку и (опционально) примеру; фиксируются критические и некритические ошибки.
- Транзакционные гарантии: атомарная запись попытки, результатов и обнаруженных ошибок; ключи корреляции для аудита.

## Адаптация
- Вход: текущие успехи по навыкам, DAG prerequisite, сложность примеров, цели (подграф навыков).
- Выбор следующего шага: топологический порядок по prerequisite + целевой уровень сложности, избегая перегрузки.
- Корректировка Roadmap: добавление/удаление задач по навыкам, изменение сложности, назначение бустеров по обнаруженным ошибкам.

## Обучение
- Методы как стратегии: генерация пошаговых объяснений, подбор примеров по применимости.
- Связь с ошибками: обнаруженные ошибки могут указывать на неверную стратегию; система назначает связанные методы для коррекции.
- Медиадоступ: унифицированные идентификаторы; доставляемые объекты из `S3`.

## Индексация и поиск (Elasticsearch)
- Индексы: по сущностям (`subjects`, `sections`, `topics`, `skills`, `methods`, `examples`, `errors`).
- BM25-поля: `title`, `description`, `statement`, `method_text`, `error_text`.
- Векторные поля: эмбеддинги для `skills`, `methods`, `examples` (например, `skill_vector`, `method_vector`, `example_vector`).
- Маппинги: текстовые поля с анализаторами языка; векторные — `dense_vector` с размерностью модели.
- Обновление: воркеры переиндексации при изменениях в OLTP; дедупликация и версионирование документов.

## Порог освоения и сложность
- Шкала сложности примера: 1 — очень легко, 2 — легко, 3 — средне, 4 — сложно, 5 — очень сложно.
- Порог освоения темы (примерная политика):
  - Точность ≥ `X%` по целевым навыкам темы (например, 85%).
  - Количество критических ошибок ≤ `Y` на окне `N` последних попыток (например, ≤1 на 10 попыток).
  - Медианное время решения ≤ `T` минут или перцентиль времени ≤ порога.
  - Устойчивость: пороги выполняются на протяжении окна наблюдения `N` попыток.
- Формализация: тема признана освоенной при выполнении порогов для `σ(тема)` и применении к `S(тема)`.

## Персонализация
- Профиль ученика: психотип, темп, цель, предпочтения формата; хранится отдельно от БЗ.
- Применение: веса и фильтры к методам, примерам и бустерам без изменения семантики БЗ.
- Источники сигналов: результаты диагностики, поведенческие метрики, явные настройки цели.
- Безопасность: персонализация — слой интерпретации поверх универсальной структуры данных.

## Интеграции
- `PostgreSQL` (OLTP): UID, сущности, связи, результаты диагностики, события ошибок.
- `Elasticsearch`: полнотекстовый поиск и поиск по векторным эмбеддингам; рекомендации по схожести.
- `RabbitMQ`: публикация событий (новая попытка, освоение навыка, обнаруженная ошибка, корректировка дорожной карты).
- `S3`: хранение мультимедиа и связанных объектов; доступ по унифицированным идентификаторам.

## Управление качеством данных
- Валидации: уникальности, внешние ключи, типы метода, обязательные роли на ребре `пример ↔ навык`.
- DAG-проверка: перед добавлением ребра `u → v` выполняется проверка ацикличности (топологическая сортировка/DFS); транзакционный запрет циклов.
- Топологическая нумерация навыков: хранится для ускорения планирования; пересчитывается при изменениях графа.
- Санитарные проверки: полнота покрытия `σ(тема)` банком примеров темы; отчёты о пробелах.

## Отчётность и аудит
- Логирование событий: попытки, результаты, ошибки, изменения графа prerequisite, переиндексации.
- Ключи корреляции: связывают попытки, рекомендации и полученные результаты.
- Аналитическая витрина: агрегаты по освоению навыков, сложности, эффективности методов и бустеров.

## Границы
- БЗ не хранит личные данные ученика; персонализация работает на весах и профиле вне БЗ.
- БЗ не содержит исполняемый код методов; только описания, применимость и связи.
- БЗ не нарушает семантику связей при индексации в `Elasticsearch` — индексы отражают тексты и эмбеддинги, а истинность остаётся в OLTP.

---

Вся модель исключает двусмысленность: навык — единица планирования и диагностики, пример — единица исполнения и проверки, метод — единица стратегии, ошибка — единица корректирующей обратной связи. Иерархия `предмет → раздел → тема` используется для адресации, фильтрации и отчётности, а дорожные карты и кластеры вычисляются над подграфом навыков с учётом `prerequisite`.
